<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Nexora - Advanced AI Assistant Suite | Vylex Nexys</title>
    
    <!-- SEO Meta Tags -->
    <meta name="description" content="Nexora - The next generation AI assistant suite with intelligent chat, weather forecasting, news updates, and productivity tools by Vylex Nexys.">
    <meta name="keywords" content="Nexora, AI assistant, artificial intelligence, Vylex Nexys, intelligent chat, weather, news, productivity">
    <meta name="author" content="Vylex Nexys">
    
    <!-- Open Graph / Social Media Meta Tags -->
    <meta property="og:title" content="Nexora - Advanced AI Assistant Suite">
    <meta property="og:description" content="Experience the future of AI assistance with Nexora by Vylex Nexys.">
    <meta property="og:type" content="website">
    <meta property="og:url" content="https://vylexnexys.co.za/nexora">
    <meta property="og:site_name" content="Vylex Nexys">
    
    <!-- Canonical URL -->
    <link rel="canonical" href="https://vylexnexys.co.za/nexora">
    
    <!-- Favicon -->
    <link rel="icon" href="favicon.ico" type="image/x-icon">
    
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <style>
        /* --- GLOBAL STYLES --- */
        :root {
            --primary-color: #4361ee;
            --primary-hover: #3a56d4;
            --secondary-color: #6c757d;
            --background-light: #f8f9fa;
            --text-light: #212529;
            --card-bg-light: #ffffff;
            --border-light: #dee2e6;

            --background-dark: #121212;
            --text-dark: #e0e0e0;
            --card-bg-dark: #1e1e1e;
            --border-dark: #343536;
            --input-bg-dark: #2a2a2a;
            --input-border-dark: #343536;

            --accent-color: #4cc9f0;
            --accent-secondary: #7209b7;
            --error-color: #dc3545;
            --success-color: #28a745;

            --font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            --border-radius: 10px;
            --box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
        }

        body {
            font-family: var(--font-family);
            margin: 0;
            padding: 0;
            transition: background-color 0.3s, color 0.3s;
            font-size: 16px;
            line-height: 1.6;
        }

        body[data-theme="light"] {
            background-color: var(--background-light);
            color: var(--text-light);
        }

        body[data-theme="dark"] {
            background-color: var(--background-dark);
            color: var(--text-dark);
        }
        
        .reduce-motion * {
            animation: none !important;
            transition: none !important;
        }

        header {
            background: linear-gradient(135deg, var(--primary-color), var(--accent-secondary));
            color: white;
            padding: 1.5rem;
            text-align: center;
            box-shadow: var(--box-shadow);
        }

        header h1 {
            margin: 0 0 0.25rem 0;
            font-size: 2.5rem;
            font-weight: 700;
            letter-spacing: -0.5px;
        }

        header p {
            margin: 0;
            opacity: 0.9;
            font-size: 1.1rem;
        }

        main {
            padding: 1.5rem;
            max-width: 1400px;
            margin: 0 auto;
        }

        .app-container {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(350px, 1fr));
            gap: 2rem;
        }
        
        .module {
            padding: 1.5rem;
            border-radius: var(--border-radius);
            box-shadow: var(--box-shadow);
            transition: transform 0.3s ease, box-shadow 0.3s ease;
        }
        
        .module:hover {
            transform: translateY(-5px);
            box-shadow: 0 8px 20px rgba(0, 0, 0, 0.2);
        }
        
        body[data-theme="light"] .module {
            background-color: var(--card-bg-light);
            border: 1px solid var(--border-light);
        }
        body[data-theme="dark"] .module {
            background-color: var(--card-bg-dark);
            border: 1px solid var(--border-dark);
        }

        .module h2 {
            margin-top: 0;
            position: relative;
            display: inline-block;
            color: var(--primary-color);
            padding-bottom: 0.5rem;
            margin-bottom: 1.5rem;
            font-weight: 600;
            font-size: 1.6rem;
        }
        
        .module h2::after {
            content: '';
            position: absolute;
            bottom: 0;
            left: 0;
            width: 100%;
            height: 3px;
            background: linear-gradient(90deg, var(--primary-color), var(--accent-color));
            border-radius: 3px;
        }
        
        .widget-container {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 1.2rem;
            margin-bottom: 1.5rem;
        }

        .widget {
            padding: 1.2rem;
            border-radius: var(--border-radius);
            transition: transform 0.2s ease;
        }
        
        .widget:hover {
            transform: translateY(-3px);
        }
        
        body[data-theme="light"] .widget {
            background-color: #f0f4f8;
            border: 1px solid #e0e6ed;
        }
        body[data-theme="dark"] .widget {
            background-color: #252830;
            border: 1px solid #353945;
        }
        
        .widget h3 {
            margin-top: 0;
            font-size: 1.2rem;
            position: relative;
            display: inline-block;
            color: var(--accent-secondary);
            padding-bottom: 0.3rem;
            margin-bottom: 1rem;
        }
        
        .widget h3::after {
            content: '';
            position: absolute;
            bottom: 0;
            left: 0;
            width: 40%;
            height: 2px;
            background-color: var(--accent-color);
            border-radius: 2px;
        }
        
        body[data-theme="dark"] .widget h3 {
            color: var(--accent-color);
        }
        
        /* Buttons and Inputs */
        button, input[type="text"], select {
            padding: 0.6rem 1rem;
            border-radius: var(--border-radius);
            font-size: 0.95rem;
            margin-bottom: 0.8rem;
            transition: all 0.2s ease;
        }
        
        input[type="text"], select {
            border: 2px solid #e0e6ed;
            box-shadow: 0 2px 5px rgba(0,0,0,0.05);
        }
        
        body[data-theme="light"] input[type="text"]:focus,
        body[data-theme="light"] select:focus {
            border-color: var(--primary-color);
            box-shadow: 0 0 0 3px rgba(67, 97, 238, 0.2);
            outline: none;
        }
        
        body[data-theme="dark"] input[type="text"], 
        body[data-theme="dark"] select {
            background-color: var(--input-bg-dark);
            color: var(--text-dark);
            border-color: var(--input-border-dark);
        }
        
        body[data-theme="dark"] input[type="text"]:focus,
        body[data-theme="dark"] select:focus {
            border-color: var(--accent-color);
            box-shadow: 0 0 0 3px rgba(76, 201, 240, 0.2);
            outline: none;
        }
        
        body[data-theme="dark"] button:hover {
            background-color: var(--primary-hover);
        }

        button {
            cursor: pointer;
            background: linear-gradient(135deg, var(--primary-color), var(--primary-hover));
            color: white;
            border: none;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
            font-weight: 500;
        }
        
        button:hover {
            background: linear-gradient(135deg, var(--primary-hover), var(--primary-color));
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.15);
        }
        
        button:active {
            transform: translateY(0);
        }
        
        button:disabled {
            background: var(--secondary-color);
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
            opacity: 0.7;
        }
        
        input[type="text"] {
            width: calc(100% - 2.2rem);
        }

        /* --- DASHBOARD: NEWS & WEATHER SPECIFIC --- */
        #weather-widget-main {
            position: relative;
            overflow: hidden;
        }
        
        #weather-widget-main::before {
            content: '';
            position: absolute;
            top: 0;
            right: 0;
            width: 100px;
            height: 100px;
            background: linear-gradient(135deg, transparent 50%, rgba(76, 201, 240, 0.1) 50%);
            border-radius: 0 0 0 100px;
            z-index: 0;
        }
        
        #weather-widget-main input[type="text"] {
            width: calc(65% - 2.2rem);
            margin-right: 0.5rem;
        }
        
        #weather-widget-main button {
            width: 30%;
        }
        
        #weather-temp { 
            font-size: 3rem; 
            font-weight: bold; 
            margin: 0.5rem 0; 
            color: var(--primary-color);
        }
        
        #weather-icon { 
            font-size: 3rem; 
            margin-right: 0.5rem;
            color: var(--accent-color);
            display: inline-block;
            vertical-align: middle;
        }
        
        #weather-desc { 
            font-style: italic; 
            opacity: 0.8; 
            font-size: 1.1rem;
            margin-bottom: 0.8rem;
        }
        
        #weather-forecast { 
            display: flex; 
            justify-content: space-around; 
            margin-top: 1rem;
            padding-top: 1rem;
            border-top: 1px solid rgba(128, 128, 128, 0.2);
        }
        
        .forecast-day { 
            text-align: center; 
            font-size: 0.9em;
            padding: 0.5rem;
            border-radius: var(--border-radius);
            transition: transform 0.2s;
        }
        
        body[data-theme="light"] .forecast-day {
            background-color: rgba(240, 244, 248, 0.7);
        }
        
        body[data-theme="dark"] .forecast-day {
            background-color: rgba(37, 40, 48, 0.7);
        }
        
        .forecast-day:hover {
            transform: scale(1.05);
        }
        
        .forecast-icon { 
            font-size: 1.8em; 
            margin: 0.3em 0;
            color: var(--accent-color);
        }

        /* Advice Widget */
        #advice-widget {
            position: relative;
            overflow: hidden;
        }
        
        #advice-widget::after {
            content: '"';
            position: absolute;
            bottom: 10px;
            right: 15px;
            font-size: 5rem;
            color: rgba(114, 9, 183, 0.1);
            font-family: Georgia, serif;
            line-height: 0;
        }
        
        #quote-text {
            font-size: 1.2em;
            font-style: italic;
            margin-bottom: 1.2rem;
            padding: 1rem;
            border-radius: var(--border-radius);
            position: relative;
            min-height: 60px;
            line-height: 1.6;
        }
        
        body[data-theme="light"] #quote-text { 
            background-color: rgba(114, 9, 183, 0.05); 
            box-shadow: inset 3px 0 0 var(--accent-secondary);
        }
        
        body[data-theme="dark"] #quote-text { 
            background-color: rgba(76, 201, 240, 0.05); 
            box-shadow: inset 3px 0 0 var(--accent-color);
        }
        
        #quote-button {
            display: block;
            width: 100%;
            text-align: center;
            background: linear-gradient(135deg, var(--accent-secondary), var(--primary-color));
        }
        
        #quote-button:hover {
            background: linear-gradient(135deg, var(--accent-secondary), var(--accent-color));
        }

        /* News Module */
        .category-filters { 
            margin-bottom: 1.2rem; 
            display: flex; 
            flex-wrap: wrap; 
            gap: 0.6rem; 
        }
        
        .category-btn { 
            background: var(--secondary-color);
            padding: 0.5rem 0.8rem;
            font-size: 0.9rem;
            border-radius: 20px;
        }
        
        .category-btn.active { 
            background: linear-gradient(90deg, var(--primary-color), var(--accent-secondary));
            font-weight: bold;
            box-shadow: 0 2px 8px rgba(67, 97, 238, 0.3);
        }
        
        #news-container {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
            gap: 1rem;
        }
        
        #news-container .card {
            padding: 1.2rem;
            margin-bottom: 1rem;
            border-radius: var(--border-radius);
            transition: all 0.3s ease;
            height: 100%;
            display: flex;
            flex-direction: column;
        }
        
        body[data-theme="light"] #news-container .card {
            background-color: var(--card-bg-light);
            border: 1px solid var(--border-light);
            box-shadow: 0 3px 10px rgba(0, 0, 0, 0.05);
        }
        
        body[data-theme="dark"] #news-container .card {
            background-color: rgba(30, 30, 30, 0.7);
            border: 1px solid var(--border-dark);
            box-shadow: 0 3px 10px rgba(0, 0, 0, 0.2);
        }
        
        #news-container .card:hover { 
            transform: translateY(-8px); 
            box-shadow: 0 8px 20px rgba(0, 0, 0, 0.15);
        }
        
        #news-container .card img { 
            max-width: 100%; 
            border-radius: var(--border-radius); 
            margin-bottom: 0.8rem; 
            object-fit: cover;
            height: 160px;
        }
        
        #news-container .card h3 { 
            margin-top: 0; 
            font-size: 1.1rem; 
            line-height: 1.4;
        }
        
        #news-container .card h3 a { 
            text-decoration: none;
            transition: color 0.2s;
        }
        
        body[data-theme="light"] #news-container .card h3 a { 
            color: var(--primary-color); 
        }
        
        body[data-theme="light"] #news-container .card h3 a:hover { 
            color: var(--accent-secondary); 
        }
        
        body[data-theme="dark"] #news-container .card h3 a { 
            color: var(--accent-color); 
        }
        
        body[data-theme="dark"] #news-container .card h3 a:hover { 
            color: #7ddfff; 
        }
        
        #news-container .card .meta-info { 
            font-size: 0.8em; 
            opacity: 0.7; 
            margin-bottom: 0.5rem;
            display: flex;
            align-items: center;
        }
        
        #news-container .card .meta-info i {
            margin-right: 5px;
            color: var(--accent-color);
        }
        
        #news-container .card .description {
            margin-top: auto;
            font-size: 0.95rem;
            opacity: 0.9;
        }

        #loading { 
            text-align: center; 
            padding: 2rem; 
            font-style: italic;
            font-size: 1.1rem;
            color: var(--secondary-color);
        }
        
        #error-container .error {
            background: linear-gradient(135deg, var(--error-color), #e63946);
            color: white;
            padding: 1rem;
            border-radius: var(--border-radius);
            margin-bottom: 1.2rem;
            text-align: center;
            box-shadow: 0 3px 8px rgba(220, 53, 69, 0.3);
        }

        /* --- NEXORA CHAT AI STYLES --- */
        #nexora-chat-module {
            display: flex;
            flex-direction: column;
            max-height: 80vh;
            position: relative;
        }
        
        #main-content {
            flex-grow: 1;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }
        
        #chat-container {
            flex-grow: 1;
            display: flex;
            flex-direction: column;
            overflow: hidden;
            border-radius: var(--border-radius);
            position: relative;
            box-shadow: 0 2px 12px rgba(0, 0, 0, 0.1);
        }
        
        body[data-theme="light"] #chat-container {
             border: 1px solid var(--border-light);
             background-color: #fdfdfd;
        }
        
        body[data-theme="dark"] #chat-container {
            border: 1px solid var(--border-dark);
            background-color: #202123;
        }

        #chat {
            flex-grow: 1;
            padding: 1.2rem;
            overflow-y: auto;
            scroll-behavior: smooth;
        }
        
        #chat::-webkit-scrollbar { 
            width: 8px; 
        }
        
        #chat::-webkit-scrollbar-track {
            background: transparent;
        }
        
        #chat::-webkit-scrollbar-thumb { 
            background-color: var(--secondary-color); 
            border-radius: 4px; 
        }
        
        #chat::-webkit-scrollbar-thumb:hover {
            background-color: var(--primary-color);
        }

        .message {
            margin-bottom: 1.2rem;
            display: flex;
            max-width: 85%;
            animation: fadeIn 0.4s ease-out;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .message-content {
            padding: 1rem 1.2rem;
            border-radius: var(--border-radius);
            line-height: 1.6;
            box-shadow: 0 2px 6px rgba(0, 0, 0, 0.1);
        }
        
        .message.user {
            margin-left: auto;
            flex-direction: row-reverse;
        }
        
        .message.user .message-content {
            background: linear-gradient(135deg, var(--primary-color), var(--primary-hover));
            color: white;
            border-bottom-right-radius: 0;
        }
        
        .message.assistant .message-content {
            border-bottom-left-radius: 0;
        }
        
        body[data-theme="light"] .message.assistant .message-content {
            background-color: #f0f4f8;
            color: var(--text-light);
            border: 1px solid #e0e6ed;
        }
        
        body[data-theme="dark"] .message.assistant .message-content {
            background-color: #2c2d36;
            color: var(--text-dark);
            border: 1px solid #3a3b45;
        }
        
        .message-time {
            font-size: 0.75em;
            opacity: 0.7;
            margin: 0.3rem 0.7rem 0;
            align-self: flex-end;
        }
        
        .message.user .message-time { 
            text-align: right; 
        }

        /* Typing indicator for Nexora */
        .typing-indicator { 
            display: flex; 
            align-items: center; 
            margin-bottom: 1rem; 
        }
        
        .typing-dot {
            width: 8px; 
            height: 8px;
            margin: 0 2px;
            border-radius: 50%;
            animation: typing 1.2s infinite ease-in-out;
        }
        
        body[data-theme="light"] .typing-dot { 
            background-color: var(--primary-color); 
        }
        
        body[data-theme="dark"] .typing-dot { 
            background-color: var(--accent-color); 
        }
        
        .typing-dot:nth-child(1) { animation-delay: -0.3s; }
        .typing-dot:nth-child(2) { animation-delay: -0.15s; }
        
        @keyframes typing {
            0%, 80%, 100% { transform: scale(0); opacity: 0.5; }
            40% { transform: scale(1.0); opacity: 1; }
        }

        #input-area {
            display: flex;
            padding: 0.8rem;
            border-top: 1px solid var(--border-light);
            background-color: rgba(248, 249, 250, 0.5);
        }
        
        body[data-theme="dark"] #input-area {
            border-top-color: var(--border-dark);
            background-color: rgba(42, 42, 46, 0.5);
        }
        
        #input-area #form {
            display: flex;
            width: 100%;
            gap: 0.6rem;
        }
        
        #input-area input[type="text"] {
            flex-grow: 1;
            margin-bottom: 0;
            padding: 0.8rem 1rem;
            border-radius: 20px;
            transition: all 0.3s ease;
        }
        
        body[data-theme="light"] #input-area input[type="text"] {
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);
        }
        
        body[data-theme="dark"] #input-area input[type="text"] {
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.15);
        }
        
        #input-area input[type="text"]:focus {
            box-shadow: 0 0 0 2px var(--primary-color);
        }
        
        #input-area button {
            width: auto;
            padding: 0.8rem;
            margin-bottom: 0;
            aspect-ratio: 1 / 1;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        }
        
        #input-area button i {
            font-size: 1.1rem;
        }
        
        #clear-input {
            background: var(--secondary-color);
        }
        
        #send-btn {
            background: linear-gradient(135deg, var(--accent-secondary), var(--primary-color));
        }
        
        #mic {
            background: linear-gradient(135deg, var(--accent-color), var(--primary-color));
        }
        
        #mic.listening {
            background: linear-gradient(135deg, var(--error-color), #e63946);
            animation: pulse 1.5s infinite;
        }
        
        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.1); }
            100% { transform: scale(1); }
        }
        
        #mic.error {
            animation: shake 0.5s;
        }
        
        @keyframes shake {
            0%, 100% { transform: translateX(0); }
            25% { transform: translateX(-5px); }
            75% { transform: translateX(5px); }
        }

        /* Nexora Settings Panel */
        #settings-btn, #clear-btn {
            position: absolute;
            top: 0.5rem;
            padding: 0.5rem;
            font-size: 1.1rem;
            background: none;
            border: none;
            opacity: 0.7;
            transition: all 0.2s ease;
            z-index: 5;
        }
        
        body[data-theme="light"] #settings-btn, 
        body[data-theme="light"] #clear-btn { 
            color: var(--primary-color); 
        }
        
        body[data-theme="dark"] #settings-btn, 
        body[data-theme="dark"] #clear-btn { 
            color: var(--accent-color); 
        }

        #settings-btn:hover, #clear-btn:hover { 
            opacity: 1; 
            transform: rotate(15deg);
        }
        
        #settings-btn { right: 0.5rem; }
        #clear-btn { right: 3rem; }

        #backdrop {
            position: fixed;
            top: 0; left: 0;
            width: 100%; height: 100%;
            background-color: rgba(0,0,0,0.6);
            backdrop-filter: blur(3px);
            z-index: 99;
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.3s, visibility 0.3s;
        }
        
        #backdrop.show { 
            opacity: 1; 
            visibility: visible; 
        }

        #settings-panel {
            position: fixed;
            top: 0; 
            right: -350px;
            width: 330px; 
            height: 100%;
            z-index: 100;
            box-shadow: -5px 0 25px rgba(0,0,0,0.3);
            transition: right 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            display: flex;
            flex-direction: column;
        }
        
        body[data-theme="light"] #settings-panel { 
            background-color: var(--background-light); 
        }
        
        body[data-theme="dark"] #settings-panel { 
            background-color: var(--background-dark); 
        }
        
        #settings-panel.open { 
            right: 0; 
        }

        .settings-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 1.2rem;
            border-bottom: 1px solid var(--border-light);
            background: linear-gradient(90deg, var(--primary-color), var(--accent-secondary));
            color: white;
        }
        
        .settings-header h2 { 
            margin: 0; 
            font-size: 1.4rem; 
            color: white;
            font-weight: 600;
        }
        
        .settings-header h2::after {
            display: none;
        }
        
        #close-settings { 
            background: none; 
            border: none; 
            font-size: 1.5rem; 
            cursor: pointer;
            color: white;
            transition: transform 0.2s;
        }
        
        #close-settings:hover {
            transform: rotate(90deg);
        }

        .settings-content { 
            padding: 1.2rem; 
            overflow-y: auto; 
            flex-grow: 1;
        }
        
        .settings-section { 
            margin-bottom: 2rem;
            padding-bottom: 1.5rem;
            border-bottom: 1px solid rgba(128, 128, 128, 0.2);
        }
        
        .settings-section:last-child {
            border-bottom: none;
            margin-bottom: 0;
        }
        
        .settings-section h3 { 
            font-size: 1.15rem; 
            margin-bottom: 1rem; 
            position: relative;
            display: inline-block;
            padding-bottom: 0.3rem;
        }
        
        .settings-section h3::after {
            content: '';
            position: absolute;
            bottom: 0;
            left: 0;
            width: 60%;
            height: 2px;
            background-color: var(--accent-color);
        }
        
        body[data-theme="light"] .settings-section h3 { 
            color: var(--primary-color); 
        }
        
        body[data-theme="dark"] .settings-section h3 { 
            color: var(--accent-color); 
        }
        
        .settings-section label { 
            display: block; 
            margin-bottom: 0.7rem; 
            font-size: 0.95rem;
        }
        
        .settings-section select, 
        .settings-section input[type="range"] { 
            width: 100%; 
            margin-bottom: 1rem;
        }
        
        .settings-section input[type="checkbox"] { 
            margin-right: 0.5rem;
            accent-color: var(--primary-color);
        }
        
        .theme-selector { 
            display: flex; 
            gap: 0.7rem; 
            margin-bottom: 1rem;
        }
        
        .theme-selector .theme-option {
            flex-grow: 1;
            background: var(--secondary-color);
            border-radius: 20px;
            padding: 0.6rem;
            text-align: center;
            color: white;
            transition: all 0.2s ease;
        }
        
        .theme-selector .theme-option.active {
            background: linear-gradient(135deg, var(--primary-color), var(--accent-secondary));
            font-weight: bold;
            box-shadow: 0 3px 10px rgba(67, 97, 238, 0.3);
            transform: scale(1.05);
        }
        
        .btn-danger { 
            background: linear-gradient(135deg, var(--error-color), #e63946);
            border-color: var(--error-color);
            width: 100%;
            font-weight: 500;
            margin-top: 1rem;
        }
        
        .btn-danger:hover { 
            background: linear-gradient(135deg, #e63946, var(--error-color));
        }

        /* Voice level for Nexora */
        .voice-level {
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 8px 0;
            margin: 10px auto 0;
            width: 90%;
            background-color: rgba(0, 0, 0, 0.05);
            border-radius: 20px;
        }
        
        .voice-level-bar {
            width: 4px;
            height: 3px;
            margin: 0 2px;
            border-radius: 2px;
            transition: height 0.1s, background-color 0.1s;
        }
        
        body[data-theme="light"] .voice-level-bar { 
            background-color: rgba(67, 97, 238, 0.3); 
        }
        
        body[data-theme="dark"] .voice-level-bar { 
            background-color: rgba(76, 201, 240, 0.3); 
        }
        
        .voice-status {
            font-size: 0.85em;
            margin-left: 10px;
            opacity: 0.8;
        }
        
        /* Nexora widget styles (weather, dictionary etc in chat) */
        .weather-widget, 
        .dictionary-widget, 
        .bible-widget, 
        .joke-widget, 
        .quote-widget {
            padding: 1rem;
            border-radius: var(--border-radius);
            margin-top: 0.8rem;
            box-shadow: 0 3px 10px rgba(0, 0, 0, 0.1);
            animation: fadeInUp 0.5s ease-out;
        }
        
        @keyframes fadeInUp {
            from {
                opacity: 0;
                transform: translateY(15px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        body[data-theme="light"] .weather-widget, 
        body[data-theme="light"] .dictionary-widget, 
        body[data-theme="light"] .bible-widget, 
        body[data-theme="light"] .joke-widget, 
        body[data-theme="light"] .quote-widget {
             background-color: #f8fafc;
             border: 1px solid #e2e8f0;
        }
        
        body[data-theme="dark"] .weather-widget, 
        body[data-theme="dark"] .dictionary-widget, 
        body[data-theme="dark"] .bible-widget, 
        body[data-theme="dark"] .joke-widget, 
        body[data-theme="dark"] .quote-widget {
            background-color: #2d2e36;
            border: 1px solid #3d3e46;
        }

        .weather-header { 
            display: flex; 
            justify-content: space-between; 
            align-items: center; 
            margin-bottom: 0.7rem;
            border-bottom: 1px solid rgba(128, 128, 128, 0.15);
            padding-bottom: 0.7rem;
        }
        
        .weather-location { 
            font-weight: bold;
            font-size: 1.1rem;
            color: var(--primary-color);
        }
        
        .weather-icon { 
            font-size: 2em;
            color: var(--accent-color);
        }
        
        .weather-temp { 
            font-size: 2em; 
            font-weight: bold; 
            margin-bottom: 0.5rem;
            color: var(--primary-color);
        }
        
        .weather-desc { 
            text-transform: capitalize; 
            margin-bottom: 0.8rem;
            font-style: italic;
            opacity: 0.8;
        }
        
        .weather-details {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 0.5rem;
        }
        
        .weather-details .weather-detail { 
            display: flex; 
            align-items: center; 
            font-size: 0.95em; 
            margin-bottom: 0.3rem;
        }
        
        .weather-details .weather-detail i { 
            margin-right: 0.7em; 
            width: 16px; 
            text-align: center;
            color: var(--accent-color);
        }

        .dict-word { 
            font-size: 1.5em; 
            font-weight: bold; 
            margin-bottom: 0.5rem;
            color: var(--primary-color);
            display: flex;
            align-items: center;
            justify-content: space-between;
        }
        
        .dict-word i { 
            font-size: 0.8em; 
            margin-left: 0.5em; 
            cursor: pointer; 
            opacity: 0.7;
            color: var(--accent-color);
            transition: all 0.2s;
        }
        
        .dict-word i:hover { 
            opacity: 1;
            transform: scale(1.1);
        }
        
        .dict-phonetic { 
            font-style: italic; 
            margin-bottom: 0.8rem;
            opacity: 0.8;
            font-size: 1.1rem;
        }
        
        .dict-part-of-speech { 
            font-weight: 600; 
            margin-top: 0.8rem; 
            font-size: 0.95em; 
            text-transform: uppercase;
            padding: 0.3rem 0.6rem;
            border-radius: 15px;
            display: inline-block;
            margin-bottom: 0.5rem;
        }
        
        body[data-theme="light"] .dict-part-of-speech { 
            color: white;
            background-color: var(--accent-secondary);
        }
        
        body[data-theme="dark"] .dict-part-of-speech { 
            color: white;
            background-color: var(--accent-color);
        }
        
        .dict-definition { 
            margin-left: 1rem; 
            margin-bottom: 0.5rem; 
            font-size: 1rem;
            position: relative;
            padding-left: 1rem;
        }
        
        .dict-definition::before {
            content: '•';
            position: absolute;
            left: 0;
            color: var(--accent-color);
        }
        
        .dict-example { 
            font-style: italic; 
            opacity: 0.8; 
            margin-left: 2rem; 
            font-size: 0.95rem;
            padding-left: 1rem;
            border-left: 2px solid var(--accent-color);
            margin-bottom: 0.8rem;
        }
        
        .bible-reference { 
            font-weight: bold; 
            display: flex; 
            justify-content: space-between; 
            align-items: center; 
            margin-bottom: 0.8rem;
            padding-bottom: 0.5rem;
            border-bottom: 1px solid rgba(128, 128, 128, 0.15);
            color: var(--primary-color);
            font-size: 1.1rem;
        }
        
        .bible-text { 
            line-height: 1.7; 
            margin-bottom: 0.5rem;
            padding: 0.5rem;
            font-size: 1.05rem;
            background-color: rgba(128, 128, 128, 0.05);
            border-radius: var(--border-radius);
        }
        
        .bible-version { 
            font-size: 0.85em; 
            text-align: right; 
            opacity: 0.7;
            font-style: italic;
        }

        .joke-icon { 
            float: left; 
            font-size: 2em; 
            margin-right: 0.8rem; 
            color: var(--accent-color);
        }
        
        .joke-content { 
            overflow: hidden; 
        }
        
        .joke-content p { 
            margin: 0 0 0.8rem 0;
            line-height: 1.6;
        }

        .quote-text { 
            font-style: italic; 
            font-size: 1.15em; 
            margin-bottom: 0.5rem;
            line-height: 1.6;
            padding: 0.5rem 1rem;
            border-left: 3px solid var(--accent-color);
            background-color: rgba(128, 128, 128, 0.05);
            border-radius: 0 var(--border-radius) var(--border-radius) 0;
        }
        
        .quote-author { 
            text-align: right; 
            font-weight: bold;
            font-size: 0.95rem;
            color: var(--accent-secondary);
        }

        /* Math output in chat */
        .math-syntax {
            font-family: 'Courier New', Courier, monospace;
            padding: 0.4em 0.6em;
            border-radius: 6px;
            font-size: 0.95em;
            display: inline-block;
            margin: 0.2rem 0;
        }
        
        body[data-theme="light"] .math-syntax { 
            background-color: #edf2f7; 
            color: #2d3748;
            border: 1px solid #e2e8f0;
        }
        
        body[data-theme="dark"] .math-syntax { 
            background-color: #2d3748; 
            color: #edf2f7;
            border: 1px solid #4a5568;
        }
        
        .math-result {
            margin-top: 0.8rem;
            padding: 0.8rem;
            border-radius: var(--border-radius);
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
        }
        
        body[data-theme="light"] .math-result { 
            background-color: rgba(76, 201, 240, 0.1);
            border-left: 3px solid var(--accent-color);
        }
        
        body[data-theme="dark"] .math-result { 
            background-color: rgba(76, 201, 240, 0.05);
            border-left: 3px solid var(--accent-color);
        }
        
        .math-result p { 
            margin: 0;
            line-height: 1.6;
        }
        
        /* Microphone permission banner for Nexora */
        .microphone-permission-banner {
            display: flex;
            align-items: center;
            padding: 1rem;
            margin-bottom: 1.2rem;
            border-radius: var(--border-radius);
            color: white;
            box-shadow: 0 3px 10px rgba(0, 0, 0, 0.15);
            animation: slideIn 0.5s ease-out;
        }
        
        @keyframes slideIn {
            from {
                transform: translateY(-20px);
                opacity: 0;
            }
            to {
                transform: translateY(0);
                opacity: 1;
            }
        }
        
        body[data-theme="light"] .microphone-permission-banner { 
            background: linear-gradient(135deg, var(--primary-color), var(--accent-secondary));
        }
        
        body[data-theme="dark"] .microphone-permission-banner { 
            background: linear-gradient(135deg, var(--primary-hover), var(--accent-secondary));
        }
        
        .microphone-permission-banner i.fa-microphone-slash { 
            font-size: 1.8rem; 
            margin-right: 1rem;
            color: rgba(255, 255, 255, 0.9);
        }
        
        .banner-content h3 { 
            margin: 0 0 0.3rem 0; 
            font-size: 1.2rem;
            font-weight: 600;
        }
        
        .banner-content p { 
            margin: 0; 
            font-size: 0.95rem; 
            opacity: 0.9;
        }
        
        .banner-button {
            margin-left: auto;
            background-color: white;
            color: var(--primary-color);
            border: none;
            font-weight: 600;
            transition: all 0.2s ease;
        }
        
        .banner-button:hover {
            background-color: var(--accent-color);
            color: white;
            transform: translateY(-2px);
        }
        
        .banner-close {
            background: none; 
            border: none; 
            color: white;
            font-size: 1.2rem; 
            margin-left: 0.5rem; 
            padding: 0.3rem;
            opacity: 0.8;
            transition: all 0.2s ease;
        }
        
        .banner-close:hover {
            opacity: 1;
            transform: rotate(90deg);
        }

        #scroll-to-bottom {
            position: absolute;
            bottom: 5rem;
            right: 1.2rem;
            background: linear-gradient(135deg, var(--primary-color), var(--accent-secondary));
            color: white;
            border: none;
            border-radius: 50%;
            width: 45px;
            height: 45px;
            font-size: 1.2rem;
            cursor: pointer;
            box-shadow: 0 3px 10px rgba(0, 0, 0, 0.2);
            opacity: 0;
            visibility: hidden;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        #scroll-to-bottom.visible {
            opacity: 0.9;
            visibility: visible;
        }
        
        #scroll-to-bottom:hover { 
            opacity: 1;
            transform: translateY(-3px);
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
        }


        footer {
            text-align: center;
            padding: 2rem 1rem;
            margin-top: 3rem;
            font-size: 0.95em;
            opacity: 0.8;
            background-color: rgba(0, 0, 0, 0.02);
        }
        
        body[data-theme="light"] footer { 
            border-top: 1px solid var(--border-light);
        }
        
        body[data-theme="dark"] footer { 
            border-top: 1px solid var(--border-dark);
        }
        
        footer p {
            margin: 0;
        }
        
        footer a {
            color: var(--primary-color);
            text-decoration: none;
            transition: color 0.2s;
        }
        
        footer a:hover {
            color: var(--accent-secondary);
            text-decoration: underline;
        }


        /* Responsive adjustments */
        @media (max-width: 768px) {
            .app-container {
                grid-template-columns: 1fr;
                gap: 1.5rem;
            }
            
            #nexora-chat-module {
                max-height: none;
            }
            
            #settings-panel {
                width: 280px;
                right: -300px;
            }
            
            header {
                padding: 1.2rem 1rem;
            }
            
            header h1 { 
                font-size: 1.8rem; 
            }
            
            header p {
                font-size: 0.95rem;
            }
            
            .module {
                padding: 1.2rem;
            }
            
            .widget-container {
                grid-template-columns: 1fr;
            }
            
            #news-container {
                grid-template-columns: 1fr;
            }
        }
        
        @media (max-width: 480px) {
            body.mobile #input-area button {
                padding: 0.6rem;
            }
            
            header h1 {
                font-size: 1.5rem;
            }
            
            .module h2 {
                font-size: 1.4rem;
            }
            
            #weather-temp {
                font-size: 2.5rem;
            }
            
            .forecast-day {
                font-size: 0.8em;
            }
            
            #quote-text {
                font-size: 1.1em;
            }
            
            #input-area input[type="text"] {
                padding: 0.7rem 0.9rem;
            }
        }
    </style>
</head>
<body>
    <header>
        <h1>Nexora - Intelligent AI Suite</h1>
        <p>By Vylex Nexys</p>
    </header>

    <main>
        <div class="app-container">
            <!-- Section 1: Dashboard (Weather, Advice, News) -->
            <section id="dashboard-module" class="module">
                <h2>Smart Dashboard</h2>
                <div class="widget-container">
                    <div id="weather-widget-main" class="widget">
                        <h3>Weather Insights</h3>
                        <input type="text" id="location-input" placeholder="Enter city (e.g., Durban, Cape Town)">
                        <button id="location-search"><i class="fas fa-search"></i> Get Weather</button>
                        <div id="weather-temp">--°C</div>
                        <div id="weather-icon"><i class="fas fa-cloud-sun"></i></div>
                        <div id="weather-desc">Enter a location to check weather</div>
                        <div id="weather-forecast"></div>
                    </div>

                    <div id="advice-widget" class="widget">
                        <h3>Daily Inspiration</h3>
                        <p id="quote-text">Loading your daily inspiration... <i class="fas fa-lightbulb"></i></p>
                        <button id="quote-button"><i class="fas fa-sync-alt"></i> New Inspiration</button>
                    </div>
                </div>

                <div id="news-module" class="widget">
                    <h3>Trending News</h3>
                    <div class="category-filters">
                        <button class="category-btn active" data-source="all"><i class="fas fa-globe"></i> All</button>
                        <button class="category-btn" data-source="worldnews"><i class="fas fa-globe-africa"></i> World</button>
                        <button class="category-btn" data-source="technology"><i class="fas fa-microchip"></i> Tech</button>
                        <button class="category-btn" data-source="science"><i class="fas fa-atom"></i> Science</button>
                        <button class="category-btn" data-source="business"><i class="fas fa-chart-line"></i> Business</button>
                        <button class="category-btn" data-source="southafrica"><i class="fas fa-flag"></i> South Africa</button>
                    </div>
                    <div id="loading" style="display: none;"><i class="fas fa-spinner fa-spin"></i> Discovering latest stories...</div>
                    <div id="error-container"></div>
                    <div id="news-container"></div>
                </div>
            </section>

            <!-- Section 2: Nexora AI Chat Assistant -->
            <section id="nexora-chat-module" class="module">
                <h2>Nexora AI Assistant</h2>
                 <button id="settings-btn" aria-label="Open Settings"><i class="fas fa-cog"></i></button>
                 <button id="clear-btn" aria-label="Clear Chat"><i class="fas fa-trash-alt"></i></button>
                <div id="main-content">
                    <div id="chat-container">
                        <div id="chat"></div>
                         <button id="scroll-to-bottom" aria-label="Scroll to bottom"><i class="fas fa-arrow-down"></i></button>
                        <div id="input-area">
                            <form id="form">
                                <button type="button" id="clear-input" aria-label="Clear input"><i class="fas fa-times"></i></button>
                                <input type="text" id="input" placeholder="Ask Nexora anything..." autocomplete="off">
                                <button type="button" id="mic" aria-label="Use microphone"><i class="fas fa-microphone"></i></button>
                                <button type="submit" id="send-btn" aria-label="Send message"><i class="fas fa-paper-plane"></i></button>
                            </form>
                        </div>
                    </div>
                </div>
            </section>
        </div>

        <!-- Nexora Settings Panel -->
        <div id="backdrop"></div>
        <div id="settings-panel">
            <div class="settings-header">
                <h2>Nexora Settings</h2>
                <button id="close-settings" aria-label="Close settings"><i class="fas fa-times"></i></button>
            </div>
            <div class="settings-content">
                <div class="settings-section">
                    <h3>Interface Theme</h3>
                    <div class="theme-selector">
                        <button class="theme-option" data-theme="light" aria-label="Light Theme" aria-pressed="false"><i class="fas fa-sun"></i> Light</button>
                        <button class="theme-option" data-theme="dark" aria-label="Dark Theme" aria-pressed="false"><i class="fas fa-moon"></i> Dark</button>
                    </div>
                     <label><input type="checkbox" id="auto-theme"> Use system theme automatically</label>
                </div>
                <div class="settings-section">
                    <h3>Voice Output</h3>
                    <label><input type="checkbox" id="tts-enabled"> Enable text-to-speech responses</label>
                    <label for="voice-select">Voice assistant:</label>
                    <select id="voice-select" aria-label="Select voice"></select>
                    <label for="voice-rate">Speech rate: <span id="rate-value">1.0</span></label>
                    <input type="range" id="voice-rate" min="0.5" max="2" step="0.1" value="1">
                    <label for="voice-pitch">Voice pitch: <span id="pitch-value">1.0</span></label>
                    <input type="range" id="voice-pitch" min="0" max="2" step="0.1" value="1">
                </div>
                 <div class="settings-section">
                    <h3>Voice Recognition</h3>
                    <label for="recognition-lang">Recognition language:</label>
                    <select id="recognition-lang">
                        <option value="en-US">English (US)</option>
                        <option value="en-GB">English (UK)</option>
                        <option value="en-ZA">English (South Africa)</option>
                        <option value="af-ZA">Afrikaans</option>
                        <option value="zu-ZA">isiZulu</option>
                        <option value="xh-ZA">isiXhosa</option>
                        <option value="es-ES">Español (España)</option>
                        <option value="fr-FR">Français (France)</option>
                    </select>
                    <label><input type="checkbox" id="auto-send"> Auto-send after voice pause</label>
                    <label><input type="checkbox" id="continuous-listening"> Keep listening continuously</label>
                    <label for="recognition-sensitivity">Microphone sensitivity: <span id="sensitivity-value">1.0</span></label>
                    <input type="range" id="recognition-sensitivity" min="0.1" max="2" step="0.1" value="1">
                </div>
                <div class="settings-section">
                    <h3>Preferences</h3>
                    <label for="weather-units">Weather units:</label>
                    <select id="weather-units">
                        <option value="metric">Celsius (°C)</option>
                        <option value="imperial">Fahrenheit (°F)</option>
                    </select>
                    <label for="bible-version">Bible reference version:</label>
                    <select id="bible-version">
                        <option value="kjv">King James Version (KJV)</option>
                        <option value="web">World English Bible (WEB)</option>
                        <option value="bbe">Bible in Basic English (BBE)</option>
                    </select>
                    <label><input type="checkbox" id="reduce-motion"> Reduce animations and motion</label>
                    <label for="font-size">Text size: <span id="font-size-value">100%</span></label>
                    <input type="range" id="font-size" min="80" max="150" step="5" value="100">
                </div>
                 <div class="settings-section">
                    <button id="reset-settings" class="btn-danger"><i class="fas fa-undo"></i> Reset All Settings</button>
                </div>
            </div>
        </div>
    </main>

    <footer>
        <p>&copy; <span id="current-year">2025</span> <a href="https://vylexnexys.co.za">Vylex Nexys</a>. Nexora AI Suite. All rights reserved.</p>
    </footer>

<script>
    // --- GLOBAL DOCUMENT READY ---
    document.addEventListener('DOMContentLoaded', () => {
        document.getElementById('current-year').textContent = new Date().getFullYear();

        // --- MODULE 1: DASHBOARD FEATURES (News, OpenMeteo Weather, AdviceSlip) ---
        const dashboardModule = (() => {
            // --- SELECTORS for Dashboard ---
            const newsContainer = document.getElementById('news-container');
            const loadingElement = document.getElementById('loading');
            const errorContainer = document.getElementById('error-container'); // Dashboard error display
            // const darkModeToggle = document.getElementById('dark-mode-toggle'); // Replaced by Nexora's theme
            const categoryButtons = document.querySelectorAll('.category-btn');
            const locationInput = document.getElementById('location-input');
            const locationSearch = document.getElementById('location-search');
            const weatherTempEl = document.getElementById('weather-temp');
            const weatherIconEl = document.getElementById('weather-icon');
            const weatherDescEl = document.getElementById('weather-desc');
            const forecastContainer = document.getElementById('weather-forecast');
            const adviceTextElement = document.getElementById('quote-text');
            const adviceButton = document.getElementById('quote-button');

            // --- STATE & CONFIG for Dashboard ---
            let currentNewsCategory = 'all';
            let cachedNews = {}; // Simple cache { category: [posts] }

            const weatherConfig = {
                openMeteoGeoUrl: 'https://geocoding-api.open-meteo.com/v1/search',
                openMeteoWeatherUrl: 'https://api.open-meteo.com/v1/forecast',
                defaultCity: 'Durban',
                weatherIconMap: { // OpenMeteo WMO Weather interpretation codes
                    0: '☀️', 1: '☀️', 2: '🌤️', 3: '☁️', // Clear, Mainly clear, Partly cloudy, Overcast
                    45: '🌫️', 48: '🌫️', // Fog and depositing rime fog
                    51: '🌦️', 53: '🌦️', 55: '🌧️', // Drizzle: Light, moderate, and dense intensity
                    56: '🌨️', 57: '🌨️', // Freezing Drizzle: Light and dense intensity
                    61: '🌧️', 63: '🌧️', 65: '🌧️', // Rain: Slight, moderate and heavy intensity
                    66: '🌨️', 67: '🌨️', // Freezing Rain: Light and heavy intensity
                    71: '❄️', 73: '❄️', 75: '❄️', // Snow fall: Slight, moderate, and heavy intensity
                    77: '❄️', // Snow grains
                    80: '🌦️', 81: '🌧️', 82: '⛈️', // Rain showers: Slight, moderate, and violent
                    85: '🌨️', 86: '🌨️', // Snow showers slight and heavy
                    95: '⛈️', // Thunderstorm: Slight or moderate
                    96: '⛈️', 99: '⛈️'  // Thunderstorm with slight and heavy hail
                },
                storageKeys: {
                    // darkMode: 'vylex_dashboard_dark_mode', // Handled by Nexora
                    lastCity: 'vylex_dashboard_last_city'
                }
            };

            const redditSources = {
                all: 'https://www.reddit.com/r/worldnews/.json?limit=15',
                worldnews: 'https://www.reddit.com/r/worldnews/.json?limit=15',
                technology: 'https://www.reddit.com/r/technology/.json?limit=15',
                science: 'https://www.reddit.com/r/science/.json?limit=15',
                business: 'https://www.reddit.com/r/business/.json?limit=15',
                southafrica: 'https://www.reddit.com/r/southafrica/.json?limit=25'
            };

            // --- DASHBOARD FUNCTIONS ---
            function loadDashboardPreferences() {
                // Dark mode is handled by Nexora globally
                const lastCity = localStorage.getItem(weatherConfig.storageKeys.lastCity) || weatherConfig.defaultCity;
                locationInput.value = lastCity;
                fetchDashboardWeather(lastCity);
            }

            function formatDashboardDate(dateString) {
                const date = new Date(dateString);
                return date.toLocaleDateString(undefined, { weekday: 'short', day: 'numeric', month: 'short'});
            }

            function showDashboardError(message) {
                clearDashboardError();
                errorContainer.innerHTML = `<div class="error">${message}</div>`;
                console.error("Dashboard Error:", message);
            }

            function clearDashboardError() {
                errorContainer.innerHTML = '';
            }

            async function fetchDashboardWeather(city) {
                clearDashboardError();
                weatherDescEl.textContent = 'Fetching weather...';
                weatherIconEl.textContent = '⏳';

                try {
                    const geoResponse = await fetch(`${weatherConfig.openMeteoGeoUrl}?name=${encodeURIComponent(city)}&count=1`);
                    if (!geoResponse.ok) throw new Error(`Geocoding error: ${geoResponse.statusText}`);
                    const geoData = await geoResponse.json();

                    if (!geoData.results || geoData.results.length === 0) {
                        throw new Error(`City '${city}' not found. Try another location.`);
                    }
                    const { latitude, longitude, name, country_code } = geoData.results[0];

                    const weatherParams = new URLSearchParams({
                        latitude: latitude,
                        longitude: longitude,
                        current: 'temperature_2m,weather_code',
                        daily: 'weather_code,temperature_2m_max,temperature_2m_min',
                        forecast_days: 5,
                        timezone: 'auto'
                    });
                    const weatherResponse = await fetch(`${weatherConfig.openMeteoWeatherUrl}?${weatherParams}`);
                    if (!weatherResponse.ok) throw new Error(`Weather fetch error: ${weatherResponse.statusText}`);
                    const weatherData = await weatherResponse.json();
                    
                    updateDashboardWeatherWidget(weatherData, name, country_code);
                    localStorage.setItem(weatherConfig.storageKeys.lastCity, name);

                } catch (error) {
                    showDashboardError(error.message || 'Failed to fetch weather. Check city or try later.');
                    weatherTempEl.textContent = '--°C';
                    weatherIconEl.textContent = '⚠️';
                    weatherDescEl.textContent = 'Error';
                    forecastContainer.innerHTML = '';
                }
            }

            function updateDashboardWeatherWidget(data, cityName, countryCode) {
                const currentTemp = Math.round(data.current.temperature_2m);
                const weatherCode = data.current.weather_code;
                const weatherIcon = weatherConfig.weatherIconMap[weatherCode] || '❓';

                weatherTempEl.textContent = `${currentTemp}°${data.current_units.temperature_2m}`;
                weatherIconEl.textContent = weatherIcon;
                weatherDescEl.textContent = `${cityName}, ${countryCode}`;

                forecastContainer.innerHTML = '';
                data.daily.time.slice(1, 5).forEach((day, index) => {
                    const dayTempMax = Math.round(data.daily.temperature_2m_max[index + 1]);
                    // const dayTempMin = Math.round(data.daily.temperature_2m_min[index + 1]); // Min temp available
                    const dayCode = data.daily.weather_code[index + 1];
                    const dayIcon = weatherConfig.weatherIconMap[dayCode] || '❓';

                    const forecastDayDiv = document.createElement('div');
                    forecastDayDiv.className = 'forecast-day';
                    forecastDayDiv.innerHTML = `
                        <div class="forecast-date">${formatDashboardDate(day)}</div>
                        <div class="forecast-icon">${dayIcon}</div>
                        <div class="forecast-temp">${dayTempMax}°${data.daily_units.temperature_2m_max}</div>
                    `;
                    forecastContainer.appendChild(forecastDayDiv);
                });
            }

            async function fetchNews(category = 'all') {
                clearDashboardError();
                loadingElement.style.display = 'block';
                newsContainer.innerHTML = '';

                if (cachedNews[category]) {
                    displayNews(cachedNews[category]);
                    loadingElement.style.display = 'none';
                    return;
                }

                try {
                    const redditUrl = redditSources[category];
                    if (!redditUrl) throw new Error(`Invalid news category: ${category}`);

                    const response = await fetch(redditUrl);
                    if (!response.ok) {
                        let errorMsg = `News fetch failed (status: ${response.status})`;
                        try { const errorData = await response.json(); errorMsg = `Reddit API Error: ${errorData.message || response.statusText}`; }
                        catch (e) { /* ignore */ }
                        throw new Error(errorMsg);
                    }

                    const data = await response.json();
                    const posts = data?.data?.children
                        .filter(post => !post?.data?.stickied && !post?.data?.over_18)
                        .slice(0, 10) || [];

                    cachedNews[category] = posts;
                    displayNews(posts);

                } catch (error) {
                    showDashboardError(error.message || 'Failed to load news. Try again later.');
                } finally {
                    loadingElement.style.display = 'none';
                }
            }

            function displayNews(posts) {
                newsContainer.innerHTML = '';
                if (!posts || posts.length === 0) {
                    newsContainer.innerHTML = '<p style="text-align: center; opacity: 0.8;">No news found for this category.</p>';
                    return;
                }

                posts.forEach(post => {
                    const item = post.data;
                    const card = document.createElement('div');
                    card.className = 'card';
                    const createdDate = new Date(item.created_utc * 1000);
                    const formattedDate = createdDate.toLocaleString(undefined, { dateStyle: 'medium', timeStyle: 'short' });
                    const title = item.title.replace(/</g, "&lt;").replace(/>/g, "&gt;");
                    let selftext = item.selftext ? item.selftext.replace(/</g, "&lt;").replace(/>/g, "&gt;") : '';
                    if (selftext.length > 150) selftext = selftext.substring(0, 150) + '...';

                    let imageUrl = '';
                    if (item.preview?.images?.[0]?.source?.url) {
                        imageUrl = item.preview.images[0].source.url.replace(/&amp;/g, '&');
                    } else if (item.thumbnail && item.thumbnail.startsWith('http')) {
                        imageUrl = item.thumbnail;
                    }

                    card.innerHTML = `
                        ${imageUrl ? `<img src="${imageUrl}" alt="Image for ${title.substring(0,30)}...">` : ''}
                        <h3><a href="https://reddit.com${item.permalink}" target="_blank" rel="noopener noreferrer">${title}</a></h3>
                        <p class="meta-info">Posted: ${formattedDate} | Subreddit: r/${item.subreddit}</p>
                        <p class="meta-info">👍 ${item.ups?.toLocaleString() || 0} | 💬 ${item.num_comments?.toLocaleString() || 0} comments</p>
                        ${selftext ? `<p>${selftext}</p>` : ''}
                        <a href="https://reddit.com${item.permalink}" target="_blank" rel="noopener noreferrer" style="font-size: 0.9em; display: inline-block; margin-top: 10px;">Read on Reddit →</a>
                    `;
                    newsContainer.appendChild(card);
                });
            }

            function changeNewsCategory(category) {
                if (currentNewsCategory === category) return;
                currentNewsCategory = category;
                categoryButtons.forEach(button => {
                    button.classList.toggle('active', button.dataset.source === category);
                });
                fetchNews(category);
            }

            function getDashboardAdvice() {
                const originalButtonText = adviceButton.innerHTML;
                adviceTextElement.style.opacity = '0.5';
                adviceTextElement.textContent = 'Thinking... 🤔';
                adviceButton.disabled = true;
                adviceButton.innerHTML = '💬 Fetching...';

                fetch('https://api.adviceslip.com/advice')
                    .then(response => {
                        if (!response.ok) throw new Error(`Advice API Error! Status: ${response.status}`);
                        return response.json();
                    })
                    .then(data => {
                        const advice = data?.slip?.advice;
                        if (advice) adviceTextElement.textContent = `"${advice}"`;
                        else throw new Error("Invalid advice format.");
                    })
                    .catch(error => {
                        adviceTextElement.textContent = "Couldn't fetch advice now.";
                        console.error('Dashboard Advice Fetch Error:', error);
                    })
                    .finally(() => {
                        adviceTextElement.style.opacity = '1';
                        adviceButton.disabled = false;
                        adviceButton.innerHTML = originalButtonText;
                    });
            }

            // --- DASHBOARD EVENT LISTENERS ---
            categoryButtons.forEach(button => {
                button.addEventListener('click', () => changeNewsCategory(button.dataset.source));
            });
            locationSearch.addEventListener('click', () => {
                const city = locationInput.value.trim();
                if (city) fetchDashboardWeather(city);
                else showDashboardError("Please enter a city name.");
            });
            locationInput.addEventListener('keypress', (e) => {
                if (e.key === 'Enter') {
                    e.preventDefault();
                    const city = locationInput.value.trim();
                    if (city) fetchDashboardWeather(city);
                    else showDashboardError("Please enter a city name.");
                }
            });
            adviceButton.addEventListener('click', getDashboardAdvice);

            // --- DASHBOARD INITIALIZATION ---
            function init() {
                loadDashboardPreferences();
                fetchNews(currentNewsCategory);
                getDashboardAdvice();
            }
            return { init };
        })();
        dashboardModule.init();


        // --- MODULE 2: NEXORA CHAT AI (with Math Integration) ---
        const nexoraAiModule = (() => {
            // DOM elements (Nexora specific)
            const chatEl = document.getElementById('chat');
            const form = document.getElementById('form');
            const input = document.getElementById('input');
            const micBtn = document.getElementById('mic');
            const settingsBtn = document.getElementById('settings-btn');
            const settingsPanel = document.getElementById('settings-panel');
            const closeSettings = document.getElementById('close-settings');
            const backdrop = document.getElementById('backdrop');
            const clearBtn = document.getElementById('clear-btn');
            const clearInputBtn = document.getElementById('clear-input');
            const voiceSelect = document.getElementById('voice-select');
            const voiceRate = document.getElementById('voice-rate');
            const voicePitch = document.getElementById('voice-pitch');
            const rateValue = document.getElementById('rate-value');
            const pitchValue = document.getElementById('pitch-value');
            const autoSendToggle = document.getElementById('auto-send');
            const recognitionLang = document.getElementById('recognition-lang');
            const themeOptions = document.querySelectorAll('#settings-panel .theme-option'); // Specific to settings panel
            const weatherUnitsNexora = document.getElementById('weather-units'); // Nexora's weather units
            const bibleVersionNexora = document.getElementById('bible-version'); // Nexora's Bible version
            const ttsEnabled = document.getElementById('tts-enabled');
            const autoTheme = document.getElementById('auto-theme');
            const continuousListening = document.getElementById('continuous-listening');
            const reduceMotion = document.getElementById('reduce-motion');
            const fontSize = document.getElementById('font-size');
            const fontSizeValue = document.getElementById('font-size-value');
            const resetSettings = document.getElementById('reset-settings');
            const scrollToBottomBtn = document.getElementById('scroll-to-bottom'); // Renamed from scrollToBottom
            const recognitionSensitivity = document.getElementById('recognition-sensitivity');
            const sensitivityValue = document.getElementById('sensitivity-value');

            // State variables
            let isListening = false;
            let recognition = null;
            let speechTimeout = null;
            let synth = window.speechSynthesis;
            let voices = [];
            let selectedVoice = null;
            let speechRate = parseFloat(localStorage.getItem('nexora_speechRate') || '1.0');
            let speechPitch = parseFloat(localStorage.getItem('nexora_speechPitch') || '1.0');
            let autoSend = localStorage.getItem('nexora_autoSend') !== 'false';
            let currentTheme = localStorage.getItem('nexora_theme') || 'light'; // Default to light to match dashboard initially
            let units = localStorage.getItem('nexora_weatherUnits') || 'metric';
            let bibleVer = localStorage.getItem('nexora_bibleVersion') || 'kjv';
            let isSpeechEnabled = localStorage.getItem('nexora_ttsEnabled') !== 'false';
            let isAutoTheme = localStorage.getItem('nexora_autoTheme') === 'true';
            let isContinuousListening = localStorage.getItem('nexora_continuousListening') === 'true';
            let isReduceMotion = localStorage.getItem('nexora_reduceMotion') === 'true';
            let fontSizePercent = parseInt(localStorage.getItem('nexora_fontSize') || '100');
            let micSensitivity = parseFloat(localStorage.getItem('nexora_micSensitivity') || '1.0');
            let audioContext = null;
            let analyser = null;
            let microphone = null;
            let volumeInterval = null;
            let lastInteractionTime = Date.now();
            let isScrolledToBottom = true;
            let mediaRecorder = null;
            let audioChunks = [];
            let audioStream = null;

            // API endpoints for Nexora
            const APIs = {
              weather: { // Nexora uses OpenWeatherMap
                base: 'https://api.openweathermap.org/data/2.5/weather',
                key: 'b4103187cb732a388eac217a5290e08a' // Provided key
              },
              dictionary: { base: 'https://api.dictionaryapi.dev/api/v2/entries/en/' },
              bible: { base: 'https://bible-api.com/' },
              jokes: { base: 'https://v2.jokeapi.dev/joke/Any?blacklistFlags=nsfw,religious,political,racist,sexist,explicit' },
              quotes: { base: 'https://api.quotable.io/random' }
            };

            // --- MATH SOLVER INTEGRATION DATA ---
            const mathCommandPatterns = {
                simplify: /^(?:math |)(?:simplify|simp)\s+(.+)$/i,
                factor: /^(?:math |)factor\s+(.+)$/i,
                derive: /^(?:math |)(?:derive|derivative|differentiate|diff)\s+(.+)$/i,
                integrate: /^(?:math |)integrate\s+(.+)$/i,
                solve: /^(?:math |)solve\s+(.+)$/i,
                limit: /^(?:math |)limit\s+(.+)$/i,
                zeroes: /^(?:math |)(?:zeroes|zeros|roots)\s+(.+)$/i,
                tangent: /^(?:math |)tangent\s+(.+)$/i,
                area: /^(?:math |)area\s+(.+)$/i,
                cos: /^(?:math |)cos\s+(.+)$/i,
                sin: /^(?:math |)sin\s+(.+)$/i,
                tan: /^(?:math |)tan\s+(.+)$/i,
                arccos: /^(?:math |)arccos\s+(.+)$/i,
                arcsin: /^(?:math |)arcsin\s+(.+)$/i,
                arctan: /^(?:math |)arctan\s+(.+)$/i,
                abs: /^(?:math |)abs\s+(.+)$/i,
                log: /^(?:math |)log\s+(.+)$/i,
                expand: /^(?:math |)expand\s+(.+)$/i,
                calculate: /^(?:math |calc|calculate|compute|evaluate|eval)\s+(.+)$/i, // More flexible
                math_help: /^(?:math help|math commands|assist math|math instructions)$/i
            };
            const mathExamples = {
                simplify: "x^2 + 2x + 1", factor: "x^2 - 4", derive: "x^3",
                integrate: "x^2", solve: "x^2 = 4", limit: "sin(x)/x as x->0",
                zeroes: "x^2 - 5x + 6", tangent: "x^2 at x=1", area: "x^2 from 0 to 1",
                cos: "pi/3", sin: "pi/4", tan: "pi/4", arccos: "0.5", arcsin: "0.5",
                arctan: "1", abs: "-5", log: "100 base 10", expand: "(x+1)^2",
                calculate: "5 * (3 + 2) / 4"
            };
            const mathCommandHelp = {
                simplify: "Simplifies a mathematical expression", factor: "Factors a polynomial",
                derive: "Finds the derivative", integrate: "Finds the indefinite integral",
                solve: "Solves an equation", limit: "Calculates a limit",
                zeroes: "Finds polynomial roots", tangent: "Finds a tangent line",
                area: "Calculates definite integral (area)", cos: "Cosine", sin: "Sine", tan: "Tangent",
                arccos: "Inverse cosine", arcsin: "Inverse sine", arctan: "Inverse tangent",
                abs: "Absolute value", log: "Logarithm (default base e)", expand: "Expands an expression",
                calculate: "Evaluates a mathematical expression"
            };

            // Nexora Intent patterns - enhanced
            const intentPatterns = {
              weather: [
                /weather (in|for) (.+)/i, /what('s| is) the weather (like )?(in|at|for) (.+)/i,
                /how('s| is) the weather (in|at|for) (.+)/i, /temperature (in|at|for) (.+)/i,
                /forecast (for|in|at) (.+)/i, /is it (hot|cold|raining|snowing|sunny|cloudy) (in|at) (.+)/i,
                /what('s| is) the temperature (in|at) (.+)/i, /how (hot|cold) is it (in|at) (.+)/i,
                /conditions (in|at) (.+)/i
              ],
              dictionary: [
                /define (.+)/i, /what (does|is|are) (.+) mean/i, /meaning of (.+)/i,
                /definition of (.+)/i, /dictionary (.+)/i, /lookup (.+)/i,
                /synonyms (for|of) (.+)/i, /explain the word (.+)/i,
                /what's the meaning of (.+)/i, /tell me about the word (.+)/i
              ],
              bible: [
                /bible verse/i, /random verse/i, /(show|tell|give) me a (bible |)verse/i,
                /quote from the bible/i, /bible (.+)/i, /verse from (.+)/i,
                /(.+) chapter (.+) verse (.+)/i, /(.+) (\d+):(\d+(?:-\d+)?)/i, // Improved reference matching
                /scripture/i, /passage from (.+)/i, /what does the bible say about (.+)/i
              ],
              jokes: [
                /tell (me |)(a |)joke/i, /joke/i, /funny/i, /make me laugh/i, /humor me/i,
                /another joke/i, /something funny/i, /got any jokes/i,
                /tell me something funny/i, /lighten the mood/i, /cheer me up/i
              ],
              quotes: [
                /quote/i, /(show|tell|give) me a quote/i, /inspirational quote/i,
                /motivate me/i, /inspiration/i, /wisdom/i, /words of wisdom/i,
                /philosophical quote/i, /famous saying/i, /thought of the day/i
              ],
              greeting: [ /^(hi|hello|hey|greetings|howdy|hola|good morning|good afternoon|good evening)( there| nexora| bot)?[!]?$/i ],
              farewell: [ /^(bye|goodbye|see you|cya|farewell|later|good night|have a good day)( nexora| bot)?[!]?$/i ],
              thanks: [ /^(thanks|thank you|thx|ty|much appreciated|appreciate it)( nexora| bot)?[!]?$/i ],
              help: [ /^(help|assist|support|how do (you|I)|what can (you|I))/i, /what can you do/i, /what are your features/i, /how (do|can) I use you/i, /give me instructions/i ],
              time: [ /what('s| is) the time/i, /what time is it/i, /current time/i, /tell me the time/i ],
              date: [ /what('s| is) (the|today'?s) date/i, /what day is (it|today)/i, /current date/i, /tell me the date/i ],
              // Math intents will be checked separately or merged carefully. For now, a separate check.
            };


            function checkSystemColorPreference() {
              if (isAutoTheme && window.matchMedia) {
                const prefersDarkScheme = window.matchMedia('(prefers-color-scheme: dark)').matches;
                setNexoraTheme(prefersDarkScheme ? 'dark' : 'light', false);
              }
            }

            function initializeAppPreferences() {
              checkSystemColorPreference(); // Check this first
              // Then apply stored theme which might override system if autoTheme is off
              setNexoraTheme(currentTheme, false); // Don't save again, just apply

              document.documentElement.style.fontSize = `${fontSizePercent}%`;
              fontSize.value = fontSizePercent;
              fontSizeValue.textContent = `${fontSizePercent}%`;
              if (isReduceMotion) document.body.classList.add('reduce-motion');
              
              if (units) weatherUnitsNexora.value = units;
              if (bibleVer) bibleVersionNexora.value = bibleVer;
              
              ttsEnabled.checked = isSpeechEnabled;
              autoTheme.checked = isAutoTheme;
              continuousListening.checked = isContinuousListening;
              reduceMotion.checked = isReduceMotion;
              autoSendToggle.checked = autoSend;
              
              voiceRate.value = speechRate;
              rateValue.textContent = speechRate.toFixed(1);
              voicePitch.value = speechPitch;
              pitchValue.textContent = speechPitch.toFixed(1);
              recognitionSensitivity.value = micSensitivity;
              sensitivityValue.textContent = micSensitivity.toFixed(1);

              // Load saved recognition language if available
              const savedLang = localStorage.getItem('nexora_recognitionLang');
              if (savedLang) {
                  recognitionLang.value = savedLang;
              } else { // Default to en-ZA if available, else en-US
                  const zaOption = Array.from(recognitionLang.options).find(opt => opt.value === 'en-ZA');
                  if (zaOption) recognitionLang.value = 'en-ZA';
                  else recognitionLang.value = 'en-US';
              }
            }

            function setNexoraTheme(theme, savePreference = true) {
              currentTheme = theme;
              document.body.setAttribute('data-theme', theme); // Global body attribute
              
              themeOptions.forEach(option => {
                option.classList.toggle('active', option.getAttribute('data-theme') === theme);
                option.setAttribute('aria-pressed', option.getAttribute('data-theme') === theme);
              });
              
              if (savePreference) {
                localStorage.setItem('nexora_theme', theme);
              }
            }

            function formatNexoraTime() {
              const now = new Date();
              return now.toLocaleTimeString(navigator.language || 'en-US', { hour: '2-digit', minute: '2-digit' });
            }

            function formatNexoraDate() {
              const now = new Date();
              return now.toLocaleDateString(navigator.language || 'en-US', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' });
            }
            
            function checkIfScrolledToBottom() {
              const tolerance = 30;
              const isAtBottom = chatEl.scrollHeight - chatEl.clientHeight - chatEl.scrollTop <= tolerance;
              if (isAtBottom !== isScrolledToBottom) {
                isScrolledToBottom = isAtBottom;
                toggleScrollToBottomButton();
              }
            }

            function toggleScrollToBottomButton() {
                scrollToBottomBtn.classList.toggle('visible', !isScrolledToBottom);
            }

            function scrollToBottomOfChat() {
              chatEl.scrollTop = chatEl.scrollHeight;
              isScrolledToBottom = true;
              toggleScrollToBottomButton();
            }

            function addMsg(text, sender, html = false) {
              const typingIndicator = document.querySelector('.typing-indicator');
              if (typingIndicator) typingIndicator.remove();

              const msgDiv = document.createElement('div');
              msgDiv.className = `message ${sender}`;
              const contentDiv = document.createElement('div');
              contentDiv.className = 'message-content';
              
              if (html) contentDiv.innerHTML = text;
              else contentDiv.innerHTML = text.replace(/\n/g, '<br>');
              
              const timeDiv = document.createElement('div');
              timeDiv.className = 'message-time';
              timeDiv.textContent = formatNexoraTime();
              
              msgDiv.appendChild(contentDiv);
              msgDiv.appendChild(timeDiv);
              chatEl.appendChild(msgDiv);
              
              if (isScrolledToBottom) scrollToBottomOfChat();
              lastInteractionTime = Date.now();
            }

            function addTypingIndicator() {
              if (document.querySelector('.typing-indicator')) return;
              const typingDiv = document.createElement('div');
              typingDiv.className = 'typing-indicator';
              typingDiv.setAttribute('aria-label', 'Nexora is typing');
              for (let i = 0; i < 3; i++) {
                const dot = document.createElement('div');
                dot.className = 'typing-dot';
                typingDiv.appendChild(dot);
              }
              chatEl.appendChild(typingDiv);
              if (isScrolledToBottom) scrollToBottomOfChat();
            }

            function speak(text) {
              if (!isSpeechEnabled || !('speechSynthesis' in window) || !synth) return;
              synth.cancel();
              const cleanText = text.replace(/<[^>]*>/g, '');
              const utterance = new SpeechSynthesisUtterance(cleanText);
              utterance.voice = selectedVoice;
              utterance.rate = speechRate;
              utterance.pitch = speechPitch;
              utterance.onerror = (event) => console.error('Speech error:', event);
              synth.speak(utterance);
            }
            
            // --- INTENT EXTRACTION (Simplified, from Nexora's original) ---
            function extractLocation(text, pattern) {
                const match = text.match(pattern);
                if (!match) return null;
                // Try common capture group indices for location
                return match[5] || match[4] || match[3] || match[2];
            }
            function extractWord(text, pattern) {
                const match = text.match(pattern);
                if (!match) return null;
                 // Try common capture group indices for word
                return match[2] || match[1];
            }
            function extractBibleReference(text, pattern) {
                const match = text.match(pattern);
                if (!match) return 'random'; // Default to random if no specific match
                
                // Pattern: "John 3:16" or "1 John 3:16-18"
                const specificRefMatch = text.match(/([1-3]?\s*[a-zA-Z]+)\s*(\d+):(\d+(?:-\d+)?)/i);
                if (specificRefMatch) {
                    return `${specificRefMatch[1].trim()} ${specificRefMatch[2]}:${specificRefMatch[3]}`;
                }
                // Pattern: "verse from John" or "passage from Psalms"
                const bookMatch = text.match(/(?:verse from|passage from|bible)\s*([1-3]?\s*[a-zA-Z]+)/i);
                if (bookMatch && bookMatch[1]) {
                    return `${bookMatch[1].trim()} random`; // Request a random verse from a specific book
                }
                 // Pattern: "what does the bible say about love"
                const topicMatch = text.match(/what does the bible say about (.+)/i);
                if (topicMatch && topicMatch[1]) {
                    return `topic:${topicMatch[1].trim()}`;
                }
                return 'random'; // Fallback
            }
            
            // --- MATH INTENT AND PROCESSING (Integrated) ---
            function getMathIntent(text) {
                for (const [command, pattern] of Object.entries(mathCommandPatterns)) {
                    const match = text.match(pattern);
                    if (match) {
                        return { intent: `math_${command}`, data: match[1]?.trim() || (command === 'math_help' ? 'help' : null), pattern };
                    }
                }
                // If no command, but looks like a math expression
                if (!text.match(/^(?:math|define|weather|bible|joke|quote|help|time|date|hi|hello)/i) && /[\d.+\-*/^()=]|sin|cos|tan|log/i.test(text)) {
                     if (text.length > 2 && text.length < 100) { // Avoid single numbers or very long texts
                        return { intent: 'math_calculate', data: text, pattern: mathCommandPatterns.calculate };
                     }
                }
                return null;
            }

            function simulateSimplify(expression) { /* From math script */
                if (expression === "x^2 + 2x + 1") return "(x + 1)²";
                if (expression === "x^2 - 1") return "(x + 1)(x - 1)";
                if (expression === "3x + 5x") return "8x";
                return `Simplified: ${expression}`; // Fallback
            }
            function simulateFactor(expression) { /* From math script */
                if (expression === "x^2 - 4") return "(x + 2)(x - 2)";
                if (expression === "x^2 - 2x + 1") return "(x - 1)²";
                return `Factored: ${expression}`;
            }
            function simulateDerivative(expression) { /* From math script */
                if (expression === "x^3") return "3x²";
                if (expression === "sin(x)") return "cos(x)";
                return `Derivative of ${expression}`;
            }
            function simulateIntegral(expression) { /* From math script */
                if (expression === "x^2") return "(x³)/3 + C";
                if (expression === "cos(x)") return "sin(x) + C";
                return `Integral of ${expression} + C`;
            }
            function simulateSolve(expression) { /* From math script */
                if (expression === "x^2 = 4") return "x = 2 or x = -2";
                if (expression === "x + 5 = 10") return "x = 5";
                return `Solution for ${expression}`;
            }
            function simulateCalculate(expression) { /* From math script */
                try {
                    // Basic eval, BE CAREFUL with eval in production
                    if (/^[\d\s.+\-*/().^%]+$/.test(expression.replace(/PI/g, Math.PI).replace(/E/g, Math.E))) {
                         // Handle powers with Math.pow for safety over ** if not supported by simple eval
                         let safeExpression = expression.replace(/(\d+(\.\d+)?)\s*\^\s*(\d+(\.\d+)?)/g, "Math.pow($1, $3)");
                         safeExpression = safeExpression.replace(/PI/g, "Math.PI").replace(/E/g, "Math.E");
                        return new Function('return ' + safeExpression)();
                    }
                    return `Result of ${expression}`;
                } catch (e) { return `Error calculating: ${e.message}`; }
            }
            // Other math simulate functions (abs, log, trig, etc.) can be added similarly
            function simulateTrig(func, val) {
                const numVal = parseFloat(val);
                if (isNaN(numVal) && !val.toLowerCase().includes('pi')) return `Invalid input for ${func}`;
                let angle = numVal;
                if (val.toLowerCase().includes('pi')) {
                    try {
                        angle = new Function('return ' + val.toLowerCase().replace(/pi/g, 'Math.PI'))();
                    } catch { return `Invalid pi expression for ${func}`; }
                }
                switch(func) {
                    case 'cos': return Math.cos(angle);
                    case 'sin': return Math.sin(angle);
                    case 'tan': return Math.tan(angle);
                    case 'arccos': return Math.acos(angle);
                    case 'arcsin': return Math.asin(angle);
                    case 'arctan': return Math.atan(angle);
                    default: return `Unknown trig function ${func}`;
                }
            }


            function generateMathResponse(command, expression) {
                let html = '', text = '';
                const operation = command.replace('math_', ''); // e.g. simplify, factor

                if (operation === 'help') {
                    html = `<p>I can help with these math operations:</p><ul style="margin-left: 1rem; font-size:0.9em;">`;
                    text = "I can help with these math operations: ";
                    for (const [cmd, desc] of Object.entries(mathCommandHelp)) {
                        html += `<li><strong>${cmd}</strong>: ${desc}<br>Example: <span class="math-syntax">${cmd} ${mathExamples[cmd] || 'expression'}</span></li>`;
                        text += `${cmd} (${desc}), `;
                    }
                    html += `</ul><p>You can also type a calculation directly.</p>`;
                    text += "You can also type a calculation directly.";
                    return { html, text };
                }

                if (!expression && operation !== 'help') {
                    return { html: `<p>Please provide an expression for the '${operation}' command. Example: <span class="math-syntax">${operation} ${mathExamples[operation] || "your_expression"}</span></p>`, text: `Please provide an expression for ${operation}.` };
                }


                let result = `Result for ${operation} of ${expression}`; // Fallback
                html = `<p>${operation.charAt(0).toUpperCase() + operation.slice(1)}: <span class="math-syntax">${expression}</span></p>`;

                switch(operation) {
                    case 'simplify': result = simulateSimplify(expression); break;
                    case 'factor': result = simulateFactor(expression); break;
                    case 'derive': result = simulateDerivative(expression); break;
                    case 'integrate': result = simulateIntegral(expression); break;
                    case 'solve': result = simulateSolve(expression); break;
                    case 'calculate': result = simulateCalculate(expression); break;
                    case 'cos': case 'sin': case 'tan': case 'arccos': case 'arcsin': case 'arctan':
                        result = simulateTrig(operation, expression); break;
                    // Add more cases for other math functions like zeroes, tangent, area, abs, log, expand
                    default:
                        result = `Sorry, I don't know how to perform '${operation}' yet. Try 'math help'.`;
                }
                
                html += `<div class="math-result"><p>Result: ${result}</p></div>`;
                text = `The ${operation} of ${expression} is ${result}.`;
                
                return { html, text };
            }
            
            // --- NEXORA'S CORE API FUNCTIONS ---
            async function getNexoraWeather(location) {
              try {
                const url = `${APIs.weather.base}?q=${encodeURIComponent(location)}&units=${weatherUnitsNexora.value}&appid=${APIs.weather.key}`;
                const response = await fetch(url);
                if (!response.ok) throw new Error(`Weather API error ${response.status}`);
                const weatherData = await response.json();
                
                const iconMap = { 'Clear': 'sun', 'Clouds': 'cloud', 'Rain': 'cloud-rain', 'Snow': 'snowflake', 'Mist': 'smog', 'Drizzle': 'cloud-sun-rain', 'Thunderstorm': 'poo-storm' };
                const icon = iconMap[weatherData.weather[0].main] || 'cloud';
                const tempUnit = weatherUnitsNexora.value === 'metric' ? '°C' : '°F';
                const windUnit = weatherUnitsNexora.value === 'metric' ? 'm/s' : 'mph';

                const html = `
                  <div class="weather-widget">
                    <div class="weather-header">
                      <div class="weather-location">${weatherData.name}, ${weatherData.sys.country}</div>
                      <i class="fas fa-${icon} weather-icon"></i>
                    </div>
                    <div class="weather-temp">${weatherData.main.temp.toFixed(1)}${tempUnit}</div>
                    <div class="weather-desc">${weatherData.weather[0].description}</div>
                    <div class="weather-details">
                      <div class="weather-detail"><i class="fas fa-temperature-high"></i><span>Feels like: ${weatherData.main.feels_like.toFixed(1)}${tempUnit}</span></div>
                      <div class="weather-detail"><i class="fas fa-wind"></i><span>Wind: ${weatherData.wind.speed.toFixed(1)} ${windUnit}</span></div>
                      <div class="weather-detail"><i class="fas fa-tint"></i><span>Humidity: ${weatherData.main.humidity}%</span></div>
                    </div>
                  </div>`;
                const text = `In ${weatherData.name}, it's ${weatherData.main.temp.toFixed(1)}${tempUnit} and ${weatherData.weather[0].description}. Feels like ${weatherData.main.feels_like.toFixed(1)}${tempUnit}.`;
                return { html, text };
              } catch (error) {
                console.error('Nexora Weather Error:', error);
                return { html: null, text: `Sorry, I couldn't get weather for ${location}.` };
              }
            }

            async function getDictionaryDefinition(word) {
              try {
                const cleanWord = word.trim().toLowerCase().split(' ')[0];
                const url = `${APIs.dictionary.base}${encodeURIComponent(cleanWord)}`;
                const response = await fetch(url);
                if (!response.ok) throw new Error(`Dictionary API Error ${response.status}`);
                const data = await response.json();
                if (!data || data.length === 0 || data.title === "No Definitions Found") {
                     return { html: null, text: `Sorry, I couldn't find a definition for "${word}".` };
                }
                
                const wordData = data[0];
                let htmlRes = `<div class="dictionary-widget"><div class="dict-word">${wordData.word} <i class="fas fa-volume-up" onclick="nexoraAiModule.speakWord('${wordData.word}')" aria-label="Pronounce"></i></div>`;
                if (wordData.phonetic) htmlRes += `<div class="dict-phonetic">${wordData.phonetic}</div>`;
                htmlRes += `<div class="dict-meanings">`;
                let textRes = `Definition for ${wordData.word}: `;

                wordData.meanings.slice(0, 2).forEach(meaning => {
                    htmlRes += `<div class="dict-part-of-speech">${meaning.partOfSpeech}</div>`;
                    textRes += `As a ${meaning.partOfSpeech}: `;
                    meaning.definitions.slice(0, 2).forEach((def, i) => {
                        htmlRes += `<div class="dict-definition">${i+1}. ${def.definition}`;
                        if (def.example) htmlRes += `<div class="dict-example">"${def.example}"</div>`;
                        htmlRes += `</div>`;
                        textRes += `${def.definition}. `;
                    });
                });
                htmlRes += `</div></div>`;
                return { html: htmlRes, text: textRes };
              } catch (error) {
                console.error('Nexora Dictionary Error:', error);
                return { html: null, text: `Sorry, I couldn't define "${word}".` };
              }
            }
            
            // Expose speakWord for dictionary pronunciation
            window.nexoraAiModule = { speakWord: (word) => {
                if (!isSpeechEnabled || !synth) return;
                const utterance = new SpeechSynthesisUtterance(word);
                utterance.voice = selectedVoice || (voices.find(v => v.lang.startsWith('en') && v.default)) || voices[0];
                utterance.rate = 0.9;
                utterance.pitch = speechPitch;
                synth.speak(utterance);
            }};


            async function getBibleVerse(reference) {
              try {
                let queryRef = reference;
                let randomVerses = ["John 3:16", "Psalm 23:1", "Proverbs 3:5", "Philippians 4:13", "Jeremiah 29:11"];
                
                if (reference === 'random' || reference.toLowerCase().endsWith('random')) {
                    const bookPart = reference.toLowerCase().replace(' random', '').trim();
                    if (bookPart && bookPart !== 'random') { // e.g. "John random"
                        // This API doesn't directly support random from book, so we pick one well-known verse
                        // A more advanced solution would fetch a chapter and pick a random verse.
                        if (bookPart.toLowerCase() === 'john') queryRef = "John 3:16";
                        else if (bookPart.toLowerCase() === 'psalm' || bookPart.toLowerCase() === 'psalms') queryRef = "Psalm 23:1";
                        else queryRef = randomVerses[Math.floor(Math.random() * randomVerses.length)];
                    } else {
                         queryRef = randomVerses[Math.floor(Math.random() * randomVerses.length)];
                    }
                } else if (reference.startsWith('topic:')) {
                    const topic = reference.substring(6).toLowerCase();
                    const topicalMap = { 'love': '1 Corinthians 13:4-7', 'faith': 'Hebrews 11:1', 'hope': 'Romans 15:13', 'peace': 'Philippians 4:7' };
                    queryRef = topicalMap[topic] || randomVerses[Math.floor(Math.random() * randomVerses.length)];
                }

                const url = `${APIs.bible.base}${encodeURIComponent(queryRef)}?translation=${bibleVersionNexora.value}`;
                const response = await fetch(url);
                if (!response.ok) throw new Error(`Bible API Error ${response.status}`);
                const data = await response.json();

                const html = `
                  <div class="bible-widget">
                    <div class="bible-reference">${data.reference} <i class="fas fa-book-open"></i></div>
                    <div class="bible-text">${data.text.trim()}</div>
                    <div class="bible-version">${data.translation_name} (${data.translation_id.toUpperCase()})</div>
                  </div>`;
                const text = `${data.reference} (${data.translation_name}): ${data.text.trim()}`;
                return { html, text };
              } catch (error) {
                console.error('Nexora Bible Error:', error);
                return { html: null, text: `Sorry, I couldn't retrieve that Bible verse. Error: ${error.message}. Try a known reference like 'John 3:16' or a different version.` };
              }
            }

            async function getJoke() {
              try {
                const url = APIs.jokes.base;
                const response = await fetch(url);
                if (!response.ok) throw new Error(`Joke API Error ${response.status}`);
                const data = await response.json();
                let joke, html;
                if (data.type === 'single') {
                  joke = data.joke;
                  html = `<div class="joke-widget"><i class="fas fa-laugh joke-icon"></i><div class="joke-content">${data.joke}</div></div>`;
                } else {
                  joke = `${data.setup}\n\n${data.delivery}`;
                  html = `<div class="joke-widget"><i class="fas fa-laugh joke-icon"></i><div class="joke-content"><p>${data.setup}</p><p><strong>${data.delivery}</strong></p></div></div>`;
                }
                return { html, text: joke };
              } catch (error) {
                console.error('Nexora Joke Error:', error);
                const fallback = "Why don't scientists trust atoms? Because they make up everything!";
                return { html: `<div class="joke-widget">${fallback}</div>`, text: fallback };
              }
            }

            async function getQuote() {
              try {
                const url = APIs.quotes.base;
                const response = await fetch(url);
                if (!response.ok) throw new Error(`Quote API Error ${response.status}`);
                const data = await response.json();
                const html = `<div class="quote-widget"><div class="quote-text">"${data.content}"</div><div class="quote-author">— ${data.author}</div></div>`;
                const text = `"${data.content}" — ${data.author}`;
                return { html, text };
              } catch (error) {
                console.error('Nexora Quote Error:', error);
                const fallback = { content: "The journey of a thousand miles begins with one step.", author: "Lao Tzu"};
                return { html: `<div class="quote-widget">"${fallback.content}" — ${fallback.author}</div>`, text: `"${fallback.content}" — ${fallback.author}` };
              }
            }

            // --- NEXORA'S RESPONSE LOGIC ---
            function getIntent(text) {
              // First, check for math intents
              const mathIntent = getMathIntent(text);
              if (mathIntent) return mathIntent;

              // Then, check for general intents
              for (const [intent, patterns] of Object.entries(intentPatterns)) {
                for (const pattern of patterns) {
                  if (pattern.test(text)) {
                    let data = null;
                    if (intent === 'weather') data = extractLocation(text, pattern);
                    else if (intent === 'dictionary') data = extractWord(text, pattern);
                    else if (intent === 'bible') data = extractBibleReference(text, pattern);
                    return { intent, data, pattern };
                  }
                }
              }
              return { intent: 'general', data: null }; // Fallback general intent
            }

            function handleGreeting() {
                const hour = new Date().getHours();
                let greeting = "Hello";
                if (hour < 12) greeting = "Good morning";
                else if (hour < 18) greeting = "Good afternoon";
                else greeting = "Good evening";
                return { html:null, text: `${greeting}! I'm Nexora, your AI assistant. How can I help you today? You can ask about weather, definitions, Bible verses, jokes, quotes, or even math problems!` };
            }
            function handleFarewell() { return { html:null, text: "Goodbye! Have a great day." }; }
            function handleThanks() { return { html:null, text: "You're welcome! Let me know if there's anything else." }; }
            function handleHelp() {
                 const helpText = `I'm Nexora AI, developed by Vylex Nexys!
                    • Weather: "Weather in Cape Town"
                    • Dictionary: "Define ubiquitous"
                    • Bible: "John 3:16" or "random verse"
                    • Jokes: "Tell me a joke"
                    • Quotes: "Give me a quote"
                    • Math: "solve x^2 - 9 = 0", "simplify (x+1)^2", "derive x^3", "calculate 2*PI*5", or "math help"
                    • Time & Date: "What time is it?"
                    Use the mic for voice input or settings (⚙️) to customize.`;
                return { html:null, text: helpText };
            }
            function handleTimeIntent() { return { html:null, text: `The current time is ${formatNexoraTime()}.` }; }
            function handleDateIntent() { return { html:null, text: `Today is ${formatNexoraDate()}.` }; }
            function handleFallback(userInput) {
                const responses = [
                    "I'm not sure how to respond to that. Try 'help' for a list of my capabilities.",
                    "My apologies, I didn't quite understand. Could you rephrase or ask for 'help'?",
                    `I can help with weather, definitions, bible verses, jokes, quotes, and math. What would you like to do? You said: "${userInput.substring(0,50)}..."`
                ];
                return { html:null, text: responses[Math.floor(Math.random() * responses.length)] };
            }

            async function getAIResponse(userInput) {
              addTypingIndicator();
              const { intent, data } = getIntent(userInput);
              let response;

              if (intent.startsWith('math_')) {
                  response = generateMathResponse(intent, data); // data is the expression or 'help'
              } else {
                  switch (intent) {
                    case 'weather': response = data ? await getNexoraWeather(data) : {html:null, text: "Which city's weather?"}; break;
                    case 'dictionary': response = data ? await getDictionaryDefinition(data) : {html:null, text: "What word to define?"}; break;
                    case 'bible': response = await getBibleVerse(data || 'random'); break;
                    case 'jokes': response = await getJoke(); break;
                    case 'quotes': response = await getQuote(); break;
                    case 'greeting': response = handleGreeting(); break;
                    case 'farewell': response = handleFarewell(); break;
                    case 'thanks': response = handleThanks(); break;
                    case 'help': response = handleHelp(); break;
                    case 'time': response = handleTimeIntent(); break;
                    case 'date': response = handleDateIntent(); break;
                    default: response = handleFallback(userInput);
                  }
              }
              // Remove typing indicator that might have been added by generateMathResponse or API calls
              const typingIndicator = document.querySelector('.typing-indicator');
              if (typingIndicator) typingIndicator.remove();
              return response;
            }

            // --- NEXORA EVENT HANDLERS & SETUP (abbreviated, uses original logic) ---
            form.addEventListener('submit', async (e) => {
              e.preventDefault();
              const userMsg = input.value.trim();
              if (!userMsg) return;
              addMsg(userMsg, 'user');
              input.value = '';
              const aiResponse = await getAIResponse(userMsg);
              if (aiResponse.html) addMsg(aiResponse.html, 'assistant', true);
              else addMsg(aiResponse.text, 'assistant');
              if (isSpeechEnabled) speak(aiResponse.text);
            });
            
            // Speech Recognition Setup (Adapted from original, with error handling)
            function setupSpeechRecognition() {
                if (!('webkitSpeechRecognition' in window) && !('SpeechRecognition' in window)) {
                    micBtn.disabled = true; micBtn.title = "Speech recognition not supported."; return null;
                }
                const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
                const rec = new SpeechRecognition();
                rec.continuous = true; rec.interimResults = true; rec.maxAlternatives = 1;
                
                rec.onstart = () => {
                    isListening = true; micBtn.classList.add('listening'); micBtn.classList.remove('error');
                    finalTranscript = ''; // Reset transcript
                    if (mediaRecorder && mediaRecorder.state === 'inactive' && audioStream) { try { mediaRecorder.start(); } catch(e){console.warn("MediaRecorder start failed", e)} }
                    createVoiceLevelVisualization();
                    speechTimeout = setTimeout(() => { if (isListening && finalTranscript.trim() === '') stopListening(); }, 7000);
                };
                rec.onerror = (event) => {
                    console.error('Speech recognition error:', event.error);
                    if (event.error === 'not-allowed' || event.error === 'permission-denied') showPermissionBanner();
                    micBtn.classList.add('error');
                    stopListening(); // Stop on most errors
                };
                rec.onend = () => {
                    clearTimeout(speechTimeout);
                    if (mediaRecorder && mediaRecorder.state === 'recording') { try { mediaRecorder.stop(); } catch(e){console.warn("MediaRecorder stop failed", e)} }
                    if (isContinuousListening && isListening) { try { setTimeout(() => rec.start(), 300); } catch (e) { stopListening(); } }
                    else stopListening();
                };

                let finalTranscript = '';
                rec.onresult = (event) => {
                    clearTimeout(speechTimeout);
                    let interimTranscript = '';
                    for (let i = event.resultIndex; i < event.results.length; ++i) {
                        if (event.results[i].isFinal) finalTranscript += event.results[i][0].transcript;
                        else interimTranscript += event.results[i][0].transcript;
                    }
                    input.value = (finalTranscript + interimTranscript).trim();
                    updateVoiceLevel(); updateVoiceLevelIndicator(input.value, event.results);

                    if (autoSend && event.results[event.results.length - 1].isFinal && finalTranscript.trim()) {
                        clearTimeout(window.autoSendTimeout);
                        window.autoSendTimeout = setTimeout(() => {
                           if (finalTranscript.trim() && isListening) {
                                stopListening(); // Stop listening before submit
                                setTimeout(() => form.requestSubmit(), 100); // Submit after a short delay
                            }
                        }, 1500);
                    }
                };
                return rec;
            }

            async function initializeAudioProcessing() {
                try {
                    if (!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia) { console.warn('Media devices not supported'); return false; }
                    audioStream = await navigator.mediaDevices.getUserMedia({ audio: true, video: false });
                    const AudioContext = window.AudioContext || window.webkitAudioContext;
                    audioContext = new AudioContext();
                    analyser = audioContext.createAnalyser();
                    microphone = audioContext.createMediaStreamSource(audioStream);
                    microphone.connect(analyser);
                    analyser.fftSize = 256; analyser.smoothingTimeConstant = 0.8;
                    if (window.MediaRecorder && MediaRecorder.isTypeSupported('audio/webm')) {
                        mediaRecorder = new MediaRecorder(audioStream, { mimeType: 'audio/webm' });
                    } else if (window.MediaRecorder && MediaRecorder.isTypeSupported('audio/ogg')) {
                         mediaRecorder = new MediaRecorder(audioStream, { mimeType: 'audio/ogg' });
                    } else {
                        console.warn("MediaRecorder not fully supported or suitable mimeType not found.");
                    }

                    if(mediaRecorder) {
                        mediaRecorder.ondataavailable = (e) => { if (e.data.size > 0) audioChunks.push(e.data); };
                        mediaRecorder.onstop = () => { audioChunks = []; /* Process if needed */ };
                    }
                    return true;
                } catch (error) {
                    console.error('Error initializing audio processing:', error);
                    showPermissionBanner(); return false;
                }
            }
            
            function showPermissionBanner() { /* ... from Nexora script ... */
                 if (document.getElementById('mic-permission-banner')) return;
                const banner = document.createElement('div');
                banner.className = 'microphone-permission-banner'; banner.id = 'mic-permission-banner';
                banner.innerHTML = `
                    <i class="fas fa-microphone-slash"></i> <div class="banner-content"><h3>Microphone Access Required</h3><p>Please allow microphone access for voice input.</p></div>
                    <button class="banner-button" id="request-mic-perm">Enable Mic</button> <button class="banner-close" id="close-mic-banner" aria-label="Dismiss"><i class="fas fa-times"></i></button>`;
                const mainCont = document.getElementById('main-content'); // Ensure this exists
                if (mainCont) mainCont.insertBefore(banner, mainCont.firstChild);
                else document.body.insertBefore(banner, document.body.firstChild);

                document.getElementById('request-mic-perm')?.addEventListener('click', async () => { if (await initializeAudioProcessing()) banner.remove(); });
                document.getElementById('close-mic-banner')?.addEventListener('click', () => banner.remove());
            }

            function updateVoiceLevel() { /* ... from Nexora script ... */
                if (!analyser) return;
                const bufferLength = analyser.frequencyBinCount; const dataArray = new Uint8Array(bufferLength);
                analyser.getByteFrequencyData(dataArray); let sum = 0;
                for (let i = 0; i < bufferLength; i++) sum += dataArray[i];
                const average = sum / bufferLength; const adjustedAverage = average * micSensitivity;
                const volume = Math.min(20, Math.max(1, Math.floor(adjustedAverage / 5)));
                const bars = document.querySelectorAll('.voice-level-bar'); if (bars.length === 0) return;
                bars.forEach((bar, i) => {
                    if (i < volume) { const intensity = Math.min(100, (i / volume) * 120); bar.style.height = `${3 + (i / 20) * 17}px`; bar.style.background = `hsl(${120 - intensity}, 80%, 50%)`; }
                    else { bar.style.height = '3px'; bar.style.background = 'var(--border-dark)'; } // Use CSS var
                });
            }
            function updateVoiceLevelIndicator(text, results) { /* ... from Nexora script ... */
                const voiceLevelDiv = document.querySelector('.voice-level'); if (!voiceLevelDiv) return;
                let statusEl = voiceLevelDiv.querySelector('.voice-status');
                if (!statusEl) { statusEl = document.createElement('div'); statusEl.className = 'voice-status'; voiceLevelDiv.appendChild(statusEl); }
                if (text) { statusEl.textContent = (results && results.length > 0 && !results[results.length - 1].isFinal) ? 'Listening...' : 'Recognized'; }
                else statusEl.textContent = 'Speak now';
            }
            
            async function startListening() {
                if (isListening || !recognition) return;
                if (!audioContext) { if (!await initializeAudioProcessing()) { micBtn.classList.add('error'); setTimeout(() => micBtn.classList.remove('error'), 2000); return; }}
                try { recognition.lang = recognitionLang.value; recognition.start(); }
                catch (error) { console.error('Error starting recognition:', error); micBtn.classList.add('error'); setTimeout(() => micBtn.classList.remove('error'), 2000); }
            }
            function stopListening() {
                if (!isListening) return; isListening = false; micBtn.classList.remove('listening');
                clearTimeout(speechTimeout); clearTimeout(window.autoSendTimeout); clearInterval(volumeInterval);
                try { if (recognition) recognition.stop(); if (mediaRecorder && mediaRecorder.state === 'recording') mediaRecorder.stop(); }
                catch (e) { console.error('Error stopping recording devices:', e); }
                const voiceLevel = document.querySelector('.voice-level'); if (voiceLevel) voiceLevel.remove();
                // Auto-send is handled by onresult now
            }
             function createVoiceLevelVisualization() { /* ... from Nexora script ... */
                if (document.querySelector('.voice-level')) return;
                const container = document.createElement('div'); container.className = 'voice-level';
                for (let i = 0; i < 20; i++) { const bar = document.createElement('div'); bar.className = 'voice-level-bar'; container.appendChild(bar); }
                const status = document.createElement('div'); status.className = 'voice-status'; status.textContent = 'Speak now'; container.appendChild(status);
                // Insert after input-area form
                const inputAreaForm = document.getElementById('input-area')?.querySelector('form');
                if (inputAreaForm && inputAreaForm.parentNode) {
                    inputAreaForm.parentNode.insertBefore(container, inputAreaForm.nextSibling);
                } else { // Fallback if structure is different
                    chatEl.parentNode.appendChild(container);
                }
                clearInterval(volumeInterval); volumeInterval = setInterval(updateVoiceLevel, 100);
            }


            micBtn.addEventListener('click', () => { isListening ? stopListening() : startListening(); });
            settingsBtn.addEventListener('click', () => { settingsPanel.classList.add('open'); backdrop.classList.add('show'); });
            closeSettings.addEventListener('click', () => { settingsPanel.classList.remove('open'); backdrop.classList.remove('show'); });
            backdrop.addEventListener('click', () => { settingsPanel.classList.remove('open'); backdrop.classList.remove('show'); });

            function loadVoices() {
                try {
                    voices = synth.getVoices();
                    if (voices.length === 0) { setTimeout(loadVoices, 100); return; }
                    voiceSelect.innerHTML = ''; // Clear old
                    const voicesByLang = {};
                    voices.forEach(v => { voicesByLang[v.lang] = voicesByLang[v.lang] || []; voicesByLang[v.lang].push(v); });
                    Object.keys(voicesByLang).sort().forEach(lang => {
                        const optGroup = document.createElement('optgroup');
                        try { optGroup.label = `${new Intl.DisplayNames([navigator.language || 'en'], { type: 'language' }).of(lang.split('-')[0])} (${lang})`; }
                        catch(e){ optGroup.label = lang; } // Fallback for unsupported lang codes in DisplayNames
                        
                        voicesByLang[lang].sort((a,b) => a.default ? -1 : b.default ? 1 : a.name.localeCompare(b.name)).forEach(voice => {
                            const option = document.createElement('option');
                            option.value = voices.indexOf(voice); option.textContent = `${voice.name}${voice.default ? ' (Default)' : ''}`;
                            optGroup.appendChild(option);
                        });
                        voiceSelect.appendChild(optGroup);
                    });

                    const savedVoiceIdx = localStorage.getItem('nexora_selectedVoice');
                    if (savedVoiceIdx && voices[savedVoiceIdx]) { voiceSelect.value = savedVoiceIdx; selectedVoice = voices[savedVoiceIdx]; }
                    else {
                        const userLang = navigator.language || 'en-US';
                        const langVoice = voices.find(v => v.lang.startsWith(userLang.split('-')[0]) && v.default);
                        const engVoice = voices.find(v => v.lang.startsWith('en') && v.default);
                        selectedVoice = langVoice || engVoice || voices[0];
                        if(selectedVoice) voiceSelect.value = voices.indexOf(selectedVoice);
                    }
                } catch (e) { console.error("Error loading voices:", e); voiceSelect.innerHTML = '<option value="">No voices</option>';}
            }

            if ('speechSynthesis' in window && synth) {
                if (synth.onvoiceschanged !== undefined) synth.onvoiceschanged = loadVoices; else setTimeout(loadVoices, 100);
            } else { voiceSelect.disabled = true; ttsEnabled.disabled = true; ttsEnabled.checked = false; }

            voiceSelect.addEventListener('change', () => {
                selectedVoice = voices[parseInt(voiceSelect.value)]; localStorage.setItem('nexora_selectedVoice', voiceSelect.value);
                if(isSpeechEnabled && selectedVoice) speak("This is how I sound.");
            });
            voiceRate.addEventListener('input', () => { speechRate = parseFloat(voiceRate.value); rateValue.textContent = speechRate.toFixed(1); localStorage.setItem('nexora_speechRate', speechRate); });
            voicePitch.addEventListener('input', () => { speechPitch = parseFloat(voicePitch.value); pitchValue.textContent = speechPitch.toFixed(1); localStorage.setItem('nexora_speechPitch', speechPitch); });
            ttsEnabled.addEventListener('change', () => { isSpeechEnabled = ttsEnabled.checked; localStorage.setItem('nexora_ttsEnabled', isSpeechEnabled); if(isSpeechEnabled) speak("TTS enabled."); else synth.cancel(); });
            autoSendToggle.addEventListener('change', () => { autoSend = autoSendToggle.checked; localStorage.setItem('nexora_autoSend', autoSend); });
            recognitionLang.addEventListener('change', () => { if (recognition) recognition.lang = recognitionLang.value; localStorage.setItem('nexora_recognitionLang', recognitionLang.value); });
            continuousListening.addEventListener('change', () => { isContinuousListening = continuousListening.checked; localStorage.setItem('nexora_continuousListening', isContinuousListening); });
            reduceMotion.addEventListener('change', () => { isReduceMotion = reduceMotion.checked; localStorage.setItem('nexora_reduceMotion', isReduceMotion); document.body.classList.toggle('reduce-motion', isReduceMotion); });
            autoTheme.addEventListener('change', () => { isAutoTheme = autoTheme.checked; localStorage.setItem('nexora_autoTheme', isAutoTheme); if (isAutoTheme) checkSystemColorPreference(); });
            fontSize.addEventListener('input', () => { fontSizePercent = parseInt(fontSize.value); fontSizeValue.textContent = `${fontSizePercent}%`; document.documentElement.style.fontSize = `${fontSizePercent}%`; localStorage.setItem('nexora_fontSize', fontSizePercent); });
            recognitionSensitivity.addEventListener('input', () => { micSensitivity = parseFloat(recognitionSensitivity.value); sensitivityValue.textContent = micSensitivity.toFixed(1); localStorage.setItem('nexora_micSensitivity', micSensitivity); });
            weatherUnitsNexora.addEventListener('change', () => { units = weatherUnitsNexora.value; localStorage.setItem('nexora_weatherUnits', units); });
            bibleVersionNexora.addEventListener('change', () => { bibleVer = bibleVersionNexora.value; localStorage.setItem('nexora_bibleVersion', bibleVer); });
            
            themeOptions.forEach(option => {
              option.addEventListener('click', () => {
                const theme = option.getAttribute('data-theme');
                setNexoraTheme(theme);
                if (isAutoTheme) { isAutoTheme = false; autoTheme.checked = false; localStorage.setItem('nexora_autoTheme', false); }
              });
            });

            resetSettings.addEventListener('click', (e) => {
                e.preventDefault();
                if (confirm('Reset all Nexora settings to default?')) {
                    // List all nexora specific localStorage keys
                    ['nexora_speechRate', 'nexora_speechPitch', 'nexora_autoSend', 'nexora_theme', 
                     'nexora_weatherUnits', 'nexora_bibleVersion', 'nexora_ttsEnabled', 'nexora_autoTheme', 
                     'nexora_continuousListening', 'nexora_reduceMotion', 'nexora_fontSize', 
                     'nexora_micSensitivity', 'nexora_recognitionLang', 'nexora_selectedVoice'].forEach(key => localStorage.removeItem(key));
                    window.location.reload();
                }
            });
            
            clearBtn.addEventListener('click', () => {
                if (confirm('Clear chat history?')) {
                    chatEl.innerHTML = '';
                    setTimeout(() => addMsg("Hello again! I'm Nexora. How can I assist?", 'assistant'), 300);
                }
            });
            clearInputBtn.addEventListener('click', () => { input.value = ''; input.focus(); });
            scrollToBottomBtn.addEventListener('click', scrollToBottomOfChat);
            chatEl.addEventListener('scroll', checkIfScrolledToBottom);

            document.addEventListener('keydown', (e) => {
              if (document.activeElement === input) return;
              if (e.key === '/') { e.preventDefault(); input.focus(); }
              if (e.altKey && e.key === 'm') { e.preventDefault(); micBtn.click(); }
              if (e.key === 'Escape' && settingsPanel.classList.contains('open')) { e.preventDefault(); closeSettings.click(); }
            });

            if (window.matchMedia) {
              window.matchMedia('(prefers-color-scheme: dark)').addEventListener('change', () => { if (isAutoTheme) checkSystemColorPreference(); });
              const mobileQuery = window.matchMedia('(max-width: 480px)');
              function handleMobileChange(e) { document.body.classList.toggle('mobile', e.matches); }
              handleMobileChange(mobileQuery); // Initial check
              try { mobileQuery.addEventListener('change', handleMobileChange); } catch(e) { mobileQuery.addListener(handleMobileChange); }
            }

            // --- NEXORA INITIALIZATION ---
            function init() {
                initializeAppPreferences();
                addMsg("Hello! I'm Nexora AI by Vylex Nexys. I can help with weather, definitions, Bible verses, jokes, quotes, and math. How can I help?", 'assistant');
                recognition = setupSpeechRecognition();
                input.focus();
            }
            return { init }; // Expose init for global call
        })();
        nexoraAiModule.init();

    }); // End DOMContentLoaded
</script>
</body>
</html>

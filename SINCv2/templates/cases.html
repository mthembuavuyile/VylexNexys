<!-- Cases.html Fragment - Refactored for SINC Legal System -->
<!-- Assumes Font Awesome & Tailwind CSS are linked -->
<div id="sinc-case-list-container" class="rounded-lg shadow-md bg-white p-6 w-full max-w-7xl mx-auto">
    <!-- Header -->
    <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center mb-6 gap-4">
        <h1 class="text-2xl font-semibold text-gray-800">Case Management</h1>
        <button id="sinc-add-case-btn" class="sinc-btn sinc-btn-primary flex items-center gap-1.5 whitespace-nowrap">
            <i class="fas fa-plus text-xs"></i>
            Add New Case
        </button>
    </div>
  
    <!-- Search and Filters -->
    <div class="flex flex-col sm:flex-row items-center gap-3 mb-4">
        <div class="relative w-full sm:flex-grow">
            <span class="absolute inset-y-0 left-0 flex items-center pl-3">
                <i class="fas fa-search text-gray-400"></i>
            </span>
            <input id="sinc-case-search" type="text" placeholder="Search by Case Name, Client, File No..." class="sinc-input pl-10 pr-4 py-2 w-full text-sm">
        </div>
        <select id="sinc-case-status-filter" class="sinc-select w-full sm:w-auto text-sm whitespace-nowrap">
            <option value="all active">Status: All Active</option> <!-- Default to active -->
            <option value="all">Status: All (Inc. Archived)</option>
            <option value="Pending Filing">Pending Filing</option>
            <option value="Discovery">Discovery</option>
            <option value="Motion Practice">Motion Practice</option>
            <option value="Trial Prep">Trial Prep</option>
            <option value="In Court">In Court</option>
            <option value="Awaiting Judgment">Awaiting Judgment</option>
            <option value="Settlement Negotiation">Settlement Negotiation</option>
            <option value="On Hold">On Hold</option>
            <option value="Settled">Settled (Archived)</option>
            <option value="Closed">Closed (Archived)</option>
        </select>
         <select id="sinc-case-priority-filter" class="sinc-select w-full sm:w-auto text-sm whitespace-nowrap">
            <option value="all">Priority: All</option>
            <option value="High">High</option>
            <option value="Medium">Medium</option>
            <option value="Low">Low</option>
        </select>
    </div>
  
    <!-- Case Table -->
    <div class="overflow-x-auto rounded-lg shadow border border-gray-200">
        <table id="sinc-case-table" class="min-w-full bg-white text-sm text-left">
            <thead class="sinc-table-header">
                <tr>
                    <th class="px-6 py-3">Case Name / File No.</th>
                    <th class="px-6 py-3">Client</th>
                    <th class="px-6 py-3">Status</th>
                    <th class="px-6 py-3">Next Deadline</th>
                    <th class="px-6 py-3">Priority</th>
                    <th class="px-6 py-3">Assigned To</th>
                    <th class="px-6 py-3 text-center">Actions</th>
                </tr>
            </thead>
            <tbody id="sinc-case-table-body" class="text-gray-700 divide-y divide-gray-200">
                <!-- Example Row 1: Data attributes link entities -->
                <tr class="hover:bg-gray-50" data-case-id="CASE001" data-client-id="CLNT002">
                    <td class="px-6 py-4 font-medium whitespace-nowrap">
                        <a href="#" class="text-indigo-600 hover:underline sinc-view-case-link" title="View Case Details">Mkhize v. Ndlovu Properties</a>
                        <div class="text-xs text-gray-500">MKH-NDL-2024/01</div>
                    </td>
                    <td class="px-6 py-4">
                        <a href="#" class="text-indigo-600 hover:underline sinc-view-client-link" title="View Client Details">Jabulani Mkhize</a>
                    </td>
                    <td class="px-6 py-4">
                        <span class="sinc-status-badge status-in-court" title="Case is currently before the court">In Court</span>
                    </td>
                    <td class="px-6 py-4 font-medium text-red-600">15 Jul 2025</td> <!-- Highlight upcoming deadline -->
                    <td class="px-6 py-4">
                         <span class="sinc-priority-badge priority-high">High</span>
                    </td>
                    <td class="px-6 py-4 text-xs text-gray-600">A. Ndlovu</td>
                    <td class="px-6 py-4 text-center">
                        <div class="flex items-center justify-center gap-2">
                            <button class="sinc-action-btn sinc-case-view-btn text-indigo-600 hover:text-indigo-800" title="View Details">
                                <i class="fas fa-eye fa-fw"></i>
                            </button>
                            <button class="sinc-action-btn sinc-case-edit-btn text-yellow-600 hover:text-yellow-800" title="Edit Case">
                                <i class="fas fa-pencil-alt fa-fw"></i>
                            </button>
                             <button class="sinc-action-btn sinc-case-add-task-btn text-green-600 hover:text-green-800" title="Add Task to Case">
                                <i class="fas fa-tasks fa-fw"></i>
                            </button>
                            <button class="sinc-action-btn sinc-case-delete-btn text-red-600 hover:text-red-800" title="Archive Case">
                                <i class="fas fa-archive fa-fw"></i> <!-- Changed to Archive -->
                            </button>
                        </div>
                    </td>
                </tr>
  
                <!-- Example Row 2 -->
                 <tr class="hover:bg-gray-50" data-case-id="CASE002" data-client-id="CLNT001">
                    <td class="px-6 py-4 font-medium whitespace-nowrap">
                        <a href="#" class="text-indigo-600 hover:underline sinc-view-case-link" title="View Case Details">Duma Labour Dispute</a>
                        <div class="text-xs text-gray-500">DUM-LAB-2024/05</div>
                    </td>
                    <td class="px-6 py-4">
                         <a href="#" class="text-indigo-600 hover:underline sinc-view-client-link" title="View Client Details">Ndipha Duma</a>
                    </td>
                    <td class="px-6 py-4">
                        <span class="sinc-status-badge status-pending" title="Awaiting initial filing or processing">Pending Filing</span>
                    </td>
                    <td class="px-6 py-4">01 Aug 2025</td>
                     <td class="px-6 py-4">
                         <span class="sinc-priority-badge priority-medium">Medium</span>
                    </td>
                     <td class="px-6 py-4 text-xs text-gray-600">B. Khumalo</td>
                    <td class="px-6 py-4 text-center">
                         <div class="flex items-center justify-center gap-2">
                            <button class="sinc-action-btn sinc-case-view-btn text-indigo-600 hover:text-indigo-800" title="View Details">
                                <i class="fas fa-eye fa-fw"></i>
                            </button>
                            <button class="sinc-action-btn sinc-case-edit-btn text-yellow-600 hover:text-yellow-800" title="Edit Case">
                                <i class="fas fa-pencil-alt fa-fw"></i>
                            </button>
                            <button class="sinc-action-btn sinc-case-add-task-btn text-green-600 hover:text-green-800" title="Add Task to Case">
                                <i class="fas fa-tasks fa-fw"></i>
                            </button>
                            <button class="sinc-action-btn sinc-case-delete-btn text-red-600 hover:text-red-800" title="Archive Case">
                                <i class="fas fa-archive fa-fw"></i>
                            </button>
                        </div>
                    </td>
                </tr>
  
                 <!-- Example Row 3 (Closed) -->
                 <tr class="hover:bg-gray-50 opacity-70" data-case-id="CASE003" data-client-id="CLNT003"> <!-- Reduced opacity for closed -->
                    <td class="px-6 py-4 font-medium whitespace-nowrap">
                        <a href="#" class="text-indigo-600 hover:underline sinc-view-case-link" title="View Case Details">Sithole Estate Admin</a>
                        <div class="text-xs text-gray-500">SIT-EST-2023/11</div>
                    </td>
                    <td class="px-6 py-4">
                        <a href="#" class="text-indigo-600 hover:underline sinc-view-client-link" title="View Client Details">Nkululeko Sithole (Exec)</a>
                    </td>
                    <td class="px-6 py-4">
                         <span class="sinc-status-badge status-closed" title="Case is completed and archived">Closed</span>
                    </td>
                    <td class="px-6 py-4 text-gray-500">â€”</td>
                     <td class="px-6 py-4">
                        <span class="sinc-priority-badge priority-low">Low</span>
                    </td>
                     <td class="px-6 py-4 text-xs text-gray-600">A. Ndlovu</td>
                    <td class="px-6 py-4 text-center">
                         <div class="flex items-center justify-center gap-2">
                            <button class="sinc-action-btn sinc-case-view-btn text-indigo-600 hover:text-indigo-800" title="View Details">
                                <i class="fas fa-eye fa-fw"></i>
                            </button>
                             <!-- No Edit/Task/Archive on closed cases typically -->
                        </div>
                    </td>
                </tr>
                 <!-- No Results Row -->
                <tr id="sinc-no-cases-row" class="hidden">
                    <td colspan="7" class="px-6 py-10 text-center text-gray-500 italic">
                        No cases found matching your criteria. Try adjusting filters or search terms.
                    </td>
                </tr>
            </tbody>
        </table>
    </div>
  
    <!-- Footer: Summary / Pagination Placeholder -->
    <div class="mt-4 flex justify-between items-center text-sm text-gray-500">
        <div id="sinc-case-summary">
            Showing <span id="sinc-showing-count">0</span> of <span id="sinc-total-count">0</span> cases
        </div>
        <!-- Add pagination controls here if needed -->
    </div>
  
    <!-- Embedded Shared Styles (Keep as is or move to global CSS) -->
    <style>
        /* Base Input/Select Styles (Example) */
        .sinc-input, .sinc-select {
            border: 1px solid #d1d5db; /* gray-300 */
            border-radius: 0.375rem; /* rounded-md */
            padding: 0.5rem 0.75rem;
            transition: border-color 0.2s ease, box-shadow 0.2s ease;
        }
        .sinc-input:focus, .sinc-select:focus {
            outline: none;
            border-color: #4f46e5; /* indigo-600 */
            box-shadow: 0 0 0 2px rgba(79, 70, 229, 0.5); /* focus:ring-indigo-500 */
        }
        .sinc-btn { padding: 0.5rem 1rem; border-radius: 0.375rem; font-weight: 500; transition: background-color 0.2s ease; }
        .sinc-btn-primary { background-color: #4f46e5; /* indigo-600 */ color: white; }
        .sinc-btn-primary:hover { background-color: #4338ca; /* indigo-700 */ }
        .sinc-table-header { background-color: #f3f4f6; /* gray-100 */ color: #4b5563; /* gray-600 */ text-transform: uppercase; letter-spacing: 0.05em; font-size: 0.75rem; font-weight: 600; }
        .sinc-action-btn { background: none; border: none; padding: 0.25rem; cursor: pointer; line-height: 1; transition: color 0.2s ease; }
  
        /* Status Badges */
        .sinc-status-badge { display: inline-block; padding: 0.2em 0.6em; font-size: 0.75rem; font-weight: 600; line-height: 1; text-align: center; white-space: nowrap; vertical-align: baseline; border-radius: 9999px; }
        .status-pending-filing { color: #065f46; background-color: #d1fae5; } /* Emerald */
        .status-discovery { color: #047857; background-color: #a7f3d0; } /* Emerald lighter */
        .status-motion-practice { color: #0369a1; background-color: #bae6fd; } /* Sky */
        .status-trial-prep { color: #7c2d12; background-color: #fed7aa; } /* Orange */
        .status-in-court { color: #92400e; background-color: #fef3c7; } /* Amber */
        .status-awaiting-judgment { color: #1e40af; background-color: #dbeafe; } /* Blue */
        .status-settlement-negotiation { color: #581c87; background-color: #e9d5ff; } /* Purple */
        .status-settled { color: #5b21b6; background-color: #ede9fe; } /* Violet */
        .status-closed { color: #3f3f46; background-color: #e4e4e7; } /* Zinc */
        .status-on-hold { color: #71717a; background-color: #f4f4f5; } /* Zinc light */
  
        /* Priority Badges */
        .sinc-priority-badge { display: inline-flex; align-items: center; gap: 0.25rem; padding: 0.15em 0.5em; font-size: 0.75rem; font-weight: 600; border-radius: 9999px; }
        .priority-high { color: #991b1b; background-color: #fee2e2; } /* Red */
        .priority-high::before { content: "â–²"; color: #dc2626; }
        .priority-medium { color: #9a3412; background-color: #ffedd5; } /* Orange */
        .priority-medium::before { content: "â–¬"; color: #f97316; }
        .priority-low { color: #166534; background-color: #dcfce7; } /* Green */
        .priority-low::before { content: "â–¼"; color: #22c55e; }
    </style>
  
    <!-- Basic Interactivity Script (Simulation) - Runs when inserted -->
    <script>
      // Wrap in an IIFE (Immediately Invoked Function Expression)
      // to avoid polluting the global scope and execute immediately.
      (() => {
          // Find the container specific to this instance of the fragment
          // This assumes the ID is unique *at the time this script runs*
          const container = document.getElementById('sinc-case-list-container');
          if (!container) {
              console.error("SINC Case List container not found. Script cannot initialize.");
              return; // Stop execution if the container isn't found
          }
  
          // Use querySelector *scoped to the container* to find elements
          const addCaseBtn = container.querySelector('#sinc-add-case-btn');
          const searchInput = container.querySelector('#sinc-case-search');
          const statusFilter = container.querySelector('#sinc-case-status-filter');
          const priorityFilter = container.querySelector('#sinc-case-priority-filter');
          const tableBody = container.querySelector('#sinc-case-table-body');
          const noResultsRow = container.querySelector('#sinc-no-cases-row');
          const showingCountEl = container.querySelector('#sinc-showing-count');
          const totalCountEl = container.querySelector('#sinc-total-count');
  
          let allRows = []; // Store rows for filtering
  
          const initCaseList = () => {
              // Guard against missing table body
              if (!tableBody) {
                  console.error("SINC Case table body not found.");
                  return;
              }
              // Select only direct children `tr` elements that are not the 'no results' row
              allRows = Array.from(tableBody.querySelectorAll(':scope > tr:not(#sinc-no-cases-row)'));
              updateSummaryCounts(true); // Update counts based on initial rows
              filterCases(); // Apply default filters ("All Active")
          };
  
          // Add New Case Simulation
          addCaseBtn?.addEventListener('click', () => {
              alert('Simulating: Open "Add New Case" form/modal...');
              // In a real app, trigger navigation or modal display
          });
  
          // --- Refined Filter Logic ---
          const filterCases = () => {
              if (!tableBody || !searchInput || !statusFilter || !priorityFilter || !noResultsRow || !showingCountEl) return; // Ensure all elements exist
  
              const searchTerm = searchInput.value.toLowerCase().trim();
              const selectedStatusFilter = statusFilter.value.toLowerCase(); // e.g., "all active", "pending filing", "all"
              const selectedPriority = priorityFilter.value.toLowerCase(); // e.g., "all", "high"
  
              let visibleCount = 0;
  
              allRows.forEach(row => {
                  const caseNameCellText = row.cells[0]?.textContent.toLowerCase() || '';
                  const clientNameCellText = row.cells[1]?.textContent.toLowerCase() || '';
                  const statusBadge = row.cells[2]?.querySelector('.sinc-status-badge');
                  // Normalize status text by removing extra spaces and converting to lower case
                  const statusText = statusBadge?.textContent.trim().toLowerCase().replace(/\s+/g, '-'); // e.g., "pending-filing"
                  const isArchived = statusText === 'settled' || statusText === 'closed';
                  const priorityBadge = row.cells[4]?.querySelector('.sinc-priority-badge');
                  // Extract just the priority level (high, medium, low)
                  const priorityText = priorityBadge?.textContent.trim().toLowerCase().split(' ')[1] || ''; // Handles "â–² High" -> "high"
  
                  // --- Filtering Conditions ---
                  // 1. Search: Check if search term is in case name or client name
                  const matchesSearch = !searchTerm || caseNameCellText.includes(searchTerm) || clientNameCellText.includes(searchTerm);
  
                  // 2. Priority: Check if priority matches or 'all' is selected
                  const matchesPriority = selectedPriority === 'all' || priorityText === selectedPriority;
  
                  // 3. Status: More complex due to "All Active" vs "All" vs specific status
                  let matchesStatus = false;
                  if (selectedStatusFilter === 'all active') {
                      matchesStatus = !isArchived; // Show if not archived
                  } else if (selectedStatusFilter === 'all') {
                      matchesStatus = true; // Show all regardless of status
                  } else {
                      matchesStatus = statusText === selectedStatusFilter.replace(/\s+/g, '-'); // Match specific status
                  }
  
                  // Determine final visibility
                  const isVisible = matchesSearch && matchesPriority && matchesStatus;
  
                  if (isVisible) {
                      row.style.display = ''; // Show row
                      row.style.opacity = isArchived ? '0.7' : '1'; // Keep dimmed style if archived
                      visibleCount++;
                  } else {
                      row.style.display = 'none'; // Hide row
                  }
              });
  
              // Update UI elements
              noResultsRow.style.display = visibleCount === 0 ? '' : 'none'; // Show/hide "No results"
              updateSummaryCounts(false, visibleCount); // Update showing count
          };
  
          // Function to update summary counts
          const updateSummaryCounts = (isInitial = false, visibleCount = 0) => {
               if (!showingCountEl || !totalCountEl) return;
              if (isInitial) {
                   totalCountEl.textContent = allRows.length; // Set total based on initial data
              }
              showingCountEl.textContent = visibleCount;
          };
  
          // Attach event listeners for filters
          searchInput?.addEventListener('input', filterCases); // Use 'input' for better responsiveness
          statusFilter?.addEventListener('change', filterCases);
          priorityFilter?.addEventListener('change', filterCases);
  
          // --- Event Delegation for Action Buttons ---
          tableBody?.addEventListener('click', (event) => {
              // Find the closest relevant element that was clicked (button or link)
              const targetButton = event.target.closest('.sinc-action-btn, .sinc-view-case-link, .sinc-view-client-link');
              if (!targetButton) return; // Exit if the click wasn't on a target element
  
              const row = targetButton.closest('tr');
              if (!row) return; // Should always find a row, but good practice to check
  
              const caseId = row.dataset.caseId;
              const clientId = row.dataset.clientId;
              const caseNameLink = row.cells[0]?.querySelector('a');
              const clientNameLink = row.cells[1]?.querySelector('a');
              const caseName = caseNameLink?.textContent || 'this case';
              const clientName = clientNameLink?.textContent || 'the client';
  
              // Prevent default link behavior if necessary (e.g., for '#' links)
               if (targetButton.matches('a') && targetButton.getAttribute('href') === '#') {
                  event.preventDefault();
              }
  
              // Handle different actions based on button class
              if (targetButton.matches('.sinc-view-case-link') || targetButton.matches('.sinc-case-view-btn')) {
                  alert(`Simulating: View Case Details for ${caseName} (ID: ${caseId})`);
                  // Real SPA: router.navigate('/cases/' + caseId);
              } else if (targetButton.matches('.sinc-view-client-link')) {
                  alert(`Simulating: View Client Details for ${clientName} (ID: ${clientId})`);
                  // Real SPA: router.navigate('/clients/' + clientId);
              } else if (targetButton.matches('.sinc-case-edit-btn')) {
                  alert(`Simulating: Open Edit form for ${caseName} (ID: ${caseId})`);
                  // Real SPA: showEditModal(caseId) or router.navigate('/cases/' + caseId + '/edit');
              } else if (targetButton.matches('.sinc-case-add-task-btn')) {
                  alert(`Simulating: Open 'Add Task' form, pre-filled for ${caseName} (ID: ${caseId})`);
                   // Real SPA: showAddTaskModal(caseId);
              } else if (targetButton.matches('.sinc-case-delete-btn')) {
                  // Use confirm for user verification
                  if (confirm(`Are you sure you want to archive the case "${caseName}"?`)) {
                      alert(`Simulating: Archiving ${caseName} (ID: ${caseId})`);
                      // --- In a real app: ---
                      // 1. Make API call to update case status to 'Closed' or 'Archived'.
                      // 2. On success, update the row visually OR re-fetch/re-render the list.
  
                      // --- Simulation: Update row visually ---
                      const statusBadge = row.cells[2]?.querySelector('.sinc-status-badge');
                      if (statusBadge) {
                          statusBadge.className = 'sinc-status-badge status-closed'; // Change class for style
                          statusBadge.textContent = 'Closed';
                          statusBadge.title = 'Case is completed and archived';
                      }
                      // Remove action buttons that no longer apply
                      row.querySelector('.sinc-case-edit-btn')?.remove();
                      row.querySelector('.sinc-case-add-task-btn')?.remove();
                      targetButton.remove(); // Remove the archive button itself
  
                      // Re-apply filters. If "All Active" is selected, this row will now hide.
                      filterCases();
                  }
              }
          });
  
          // --- Initial Setup ---
          // Run the initialization function once the script executes
          initCaseList();
  
      })(); // End of IIFE
    </script>
  
  </div>
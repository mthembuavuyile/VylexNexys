<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Productivo â€“ Free Productivity Tool</title>
    
    <meta name="description" content="Productivo is a free note-taking and task management tool with local storage support. Format text, tag and star notes, search content, filter tasks by date or priority, and view everything in a calendar." />
    <meta name="keywords" content="productivity, free tool, note-taking, task manager, calendar, to-do list, local storage, organizer" />
    <meta name="author" content="Vylex Nexys" />
    
    <link rel="canonical" href="https://vylexnexys.co.za/productivo.html" />

    <!-- TailwindCSS -->
    <script src="https://cdn.tailwindcss.com"></script>

    <!-- Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>

    <!-- Google Fonts: Inter -->
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet" />

    <style>
        :root {
            --primary-color: #2563eb; /* Tailwind blue-600 */
            --secondary-color: #f3f4f6; /* Tailwind gray-100 */
            --text-color: #1f2937; /* Tailwind gray-800 */
            --border-color: #e5e7eb; /* Tailwind gray-200 */
        }
        body {
            font-family: 'Inter', sans-serif;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }
        ::-webkit-scrollbar { width: 8px; height: 8px; }
        ::-webkit-scrollbar-track { background: #f1f5f9; }
        ::-webkit-scrollbar-thumb { background: #94a3b8; border-radius: 10px; }
        ::-webkit-scrollbar-thumb:hover { background: #64748b; }
        .line-clamp-3 {
            overflow: hidden;
            display: -webkit-box;
            -webkit-box-orient: vertical;
            -webkit-line-clamp: 3;
            line-clamp: 3;
        }
        .note-editor {
            min-height: calc(100vh - 350px);
            font-family: 'Inter', sans-serif;
            line-height: 1.6;
        }
        .note-content strong { font-weight: 600; }
        .note-content em { font-style: italic; }
        .note-content u { text-decoration: underline; }
        .note-content strike { text-decoration: line-through; }
        .note-content ul { 
            list-style-type: disc; 
            margin-left: 20px; 
            margin-top: 8px; 
            margin-bottom: 8px; 
            padding-left: 8px;
        }
        .note-content ol { 
            list-style-type: decimal; 
            margin-left: 20px; 
            margin-top: 8px; 
            margin-bottom: 8px; 
            padding-left: 8px;
        }
        .note-content li { 
            margin-bottom: 4px; 
            line-height: 1.5;
        }
        .note-content ul ul, .note-content ol ol { margin-top: 4px; }
        .popover {
            z-index: 50;
            min-width: 250px;
            max-width: 300px;
            background: #fff;
            box-shadow: 0 4px 20px rgba(0,0,0,.15);
            border-radius: 0.75rem;
            border: 1px solid #e5e7eb;
            padding: 1rem;
            font-size: 0.95rem;
        }
        .popover-close {
            position: absolute;
            right: 0.5rem;
            top: 0.5rem;
            cursor: pointer;
            width: 1.5rem;
            height: 1.5rem;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 99px;
            color: #64748b;
        }
         .popover-close:hover {
            background-color: #f1f5f9;
            color: #1e293b;
        }
        .dashboard-tile {
            transition: transform 0.2s ease, box-shadow 0.2s ease;
            cursor: pointer;
        }
        .dashboard-tile:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 25px rgba(0,0,0,0.1);
        }

        /* Add this CSS inside your existing <style> tag */

@media (max-width: 767px) { /* This targets mobile screens, below Tailwind's 'md' breakpoint */

    /*
     * Mobile Search Bar Enhancement
     *
     * By default, this collapses the search bar into an icon.
     * When the user taps the icon, the search bar expands for input.
     * This prevents the header title from wrapping on small screens.
    */
    
    /* Target the search input by its ID */
    #search-input {
        /* Collapse the input to the width of its left padding (pl-10 = 2.5rem).
           This makes the text input area disappear, leaving only space for the icon. */
        width: 2.5rem;
        
        /* Make the input itself and any text/cursor invisible when collapsed */
        color: transparent;
        background-color: transparent;
        border-color: transparent;
        
        /* Change cursor to a pointer to indicate it's clickable */
        cursor: pointer;
        
        /* Add a smooth transition for the expansion animation */
        transition: width 0.3s ease-in-out;
    }

    /* Hide the placeholder text when the input is collapsed */
    #search-input::placeholder {
        color: transparent;
    }

    /* When the input is focused (tapped on mobile) */
    #search-input:focus {
        /* Expand the input to a fixed, usable width */
        width: 12rem; /* 192px */
        
        /* Restore the original visual styles for typing */
        color: #1f2937; /* var(--text-color) */
        background-color: #fff;
        border: 1px solid #d1d5db; /* Tailwind's gray-300 */
        cursor: text;
        
        /* Note: The original focus ring style from the Tailwind class 
           (focus:ring-2) will still apply correctly. */
    }

    /* Restore the placeholder text when the input is expanded and ready for typing */
    #search-input:focus::placeholder {
        color: #9ca3af; /* Tailwind's gray-400 */
    }
}
    </style>
</head>
<body class="bg-gray-100">
    <div id="app-container" class="relative min-h-screen md:flex">
        <aside id="sidebar" class="w-64 bg-gray-900 text-white transition-transform duration-300 flex flex-col shrink-0 fixed inset-y-0 left-0 z-30 -translate-x-full md:relative md:translate-x-0">
            <div class="p-4 border-b border-gray-700 flex items-center justify-between">
                <h1 id="sidebar-title" class="text-xl font-bold transition-opacity">Productivo</h1>
                <button id="sidebar-toggle" class="p-1 hover:bg-gray-700 rounded hidden md:block">
                    <i data-lucide="panel-left-close" class="w-6 h-6"></i>
                </button>
            </div>
            <nav id="sidebar-nav" class="flex-1 p-4 space-y-2 overflow-y-auto"></nav>
            <div id="sidebar-footer" class="p-4 border-t border-gray-700">
                 <a href="https://vylexnexys.co.za" target="_blank" class="text-xs text-gray-500 hover:text-gray-300 transition-colors block w-full text-center truncate">
                     Developed by Vylex Nexys
                 </a>
            </div>
        </aside>
        <div id="sidebar-overlay" class="fixed inset-0 bg-black/60 z-20 hidden md:hidden"></div>
        <div class="flex-1 flex flex-col overflow-hidden">
            <header class="bg-white border-b border-gray-200 px-6 py-4 shrink-0">
                <div class="flex items-center justify-between">
                    <div class="flex items-center gap-2">
                        <button id="mobile-menu-btn" class="md:hidden p-1 -ml-2 text-gray-600 hover:text-gray-900">
                             <i data-lucide="menu" class="w-6 h-6"></i>
                        </button>
                        <h2 id="header-title" class="text-2xl font-semibold text-gray-800 capitalize">Dashboard</h2>
                        <div id="header-date" class="text-sm text-gray-500 hidden md:block"></div>
                    </div>
                    <div class="flex items-center gap-4">
                        <div class="relative">
                            <i data-lucide="search" class="absolute left-3 top-1/2 transform -translate-y-1/2 text-gray-400 w-5 h-5"></i>
                            <input
                                id="search-input"
                                type="text"
                                placeholder="Search notes..."
                                class="w-full md:w-64 pl-10 pr-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"
                            />
                        </div>
                    </div>
                </div>
            </header>
            <main id="main-content" class="flex-1 overflow-y-auto p-6 bg-gray-50"></main>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const APP_STORAGE_KEY = 'productivo_app_state';

            // --- STATE MANAGEMENT ---
            const state = {
                currentView: 'dashboard',
                selectedDate: new Date(),
                notes: [],
                tasks: [],
                searchQuery: '',
                sidebarCollapsed: false,
                editingNoteId: null,
                taskSort: 'date',
            };

            const navItems = [
                { id: 'dashboard', icon: 'layout-dashboard', label: 'Dashboard' },
                { id: 'notes', icon: 'notebook-tabs', label: 'Notes' },
                { id: 'tasks', icon: 'check-square', label: 'Tasks' },
                { id: 'calendar', icon: 'calendar', label: 'Calendar' },
            ];

            const viewTitles = {
                'dashboard': 'Dashboard',
                'notes': 'All Notes',
                'tasks': 'Task List',
                'calendar': 'Calendar',
                'note-editor': 'Note Editor'
            };

            const tagColors = {
                'work': { bg: 'bg-blue-100', text: 'text-blue-800', border: 'border-blue-200' },
                'personal': { bg: 'bg-green-100', text: 'text-green-800', border: 'border-green-200' },
                'school': { bg: 'bg-purple-100', text: 'text-purple-800', border: 'border-purple-200' },
                'general': { bg: 'bg-gray-100', text: 'text-gray-800', border: 'border-gray-200' }
            };
            
            // --- DATE HELPER ---
            const toLocalDateString = (date) => {
                const year = date.getFullYear();
                const month = String(date.getMonth() + 1).padStart(2, '0');
                const day = String(date.getDate()).padStart(2, '0');
                return `${year}-${month}-${day}`;
            };

            // --- DOM ELEMENT SELECTORS ---
            const app = {
                sidebar: document.getElementById('sidebar'),
                sidebarTitle: document.getElementById('sidebar-title'),
                sidebarToggle: document.getElementById('sidebar-toggle'),
                sidebarNav: document.getElementById('sidebar-nav'),
                sidebarFooter: document.getElementById('sidebar-footer'),
                sidebarOverlay: document.getElementById('sidebar-overlay'),
                mobileMenuBtn: document.getElementById('mobile-menu-btn'),
                headerTitle: document.getElementById('header-title'),
                headerDate: document.getElementById('header-date'),
                searchInput: document.getElementById('search-input'),
                mainContent: document.getElementById('main-content'),
            };

            // --- DATA PERSISTENCE ---
            const saveState = () => {
                try {
                    const stateToSave = { notes: state.notes, tasks: state.tasks };
                    localStorage.setItem(APP_STORAGE_KEY, JSON.stringify(stateToSave));
                } catch (e) {
                    console.error("Failed to save state to localStorage", e);
                }
            };

            const loadState = () => {
                try {
                    const savedState = localStorage.getItem(APP_STORAGE_KEY);
                    if (savedState) {
                        const parsed = JSON.parse(savedState);
                        state.notes = parsed.notes || [];
                        state.tasks = parsed.tasks || [];
                    }
                } catch (e) {
                    console.error("Failed to load or parse state, using empty state.", e);
                    state.notes = [];
                    state.tasks = [];
                }
            };

            // --- RENDER FUNCTIONS ---
            const renderSidebar = () => {
                app.sidebarNav.innerHTML = navItems.map(item => `
                    <button
                        onclick="window.app.setView('${item.id}')"
                        title="${item.label}"
                        class="w-full flex items-center gap-3 p-3 rounded-lg transition-colors ${
                        state.currentView === item.id 
                            ? 'bg-blue-600 text-white' 
                            : 'text-gray-300 hover:bg-gray-700 hover:text-white'
                        } ${state.sidebarCollapsed ? 'justify-center' : ''}"
                    >
                      <i data-lucide="${item.icon}" class="w-6 h-6 shrink-0"></i>
                      ${!state.sidebarCollapsed ? `<span>${item.label}</span>` : ''}
                    </button>
                `).join('');
                lucide.createIcons();
            };

            const renderDashboard = () => {
                const completedTasks = state.tasks.filter(t => t.completed).length;
                const pendingTasks = state.tasks.length - completedTasks;
                const starredNotes = state.notes.filter(n => n.starred).length;

                const dashboardTiles = [
                    { title: 'Total Notes', value: state.notes.length, color: 'blue', view: 'notes' },
                    { title: 'Completed Tasks', value: completedTasks, color: 'green', view: 'tasks' },
                    { title: 'Pending Tasks', value: pendingTasks, color: 'purple', view: 'tasks' },
                    { title: 'Starred Notes', value: starredNotes, color: 'orange', view: 'notes' }
                ];

                return `
                    <div class="space-y-6">
                        <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-6">
                            ${dashboardTiles.map(card => `
                            <div class="dashboard-tile bg-gradient-to-br from-${card.color}-500 to-${card.color}-600 text-white p-6 rounded-xl shadow-lg" onclick="window.app.setView('${card.view}')">
                                <h3 class="text-lg font-semibold">${card.title}</h3>
                                <p class="text-4xl font-bold mt-2">${card.value}</p>
                            </div>`).join('')}
                        </div>
                        <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                            <div class="bg-white rounded-xl shadow-sm border border-gray-200 p-6">
                                <h3 class="text-xl font-semibold mb-4">Recent Notes</h3>
                                <div class="space-y-3">
                                    ${state.notes.length > 0 ? state.notes.slice(0, 3).map(note => `
                                    <div class="flex items-center gap-3 p-3 hover:bg-gray-50 rounded-lg cursor-pointer" onclick="window.app.openNoteEditor(${note.id})">
                                        <i data-lucide="file-text" class="w-5 h-5 text-blue-500 shrink-0"></i>
                                        <div class="flex-1 overflow-hidden">
                                            <h4 class="font-medium truncate">${note.title}</h4>
                                            <div class="text-sm text-gray-500 truncate note-content">${note.content.replace(/<[^>]*>?/gm, ' ')}</div>
                                        </div>
                                        ${note.starred ? '<i data-lucide="star" class="w-5 h-5 text-yellow-400 fill-current"></i>' : ''}
                                    </div>`).join('') : '<p class="text-gray-500">No notes yet. Create one!</p>'}
                                </div>
                            </div>
                            <div class="bg-white rounded-xl shadow-sm border border-gray-200 p-6">
                                <h3 class="text-xl font-semibold mb-4">Upcoming Tasks</h3>
                                <div class="space-y-3">
                                    ${state.tasks.filter(t => !t.completed).length > 0 ? state.tasks.filter(t => !t.completed).slice(0, 3).map(task => `
                                    <div class="flex items-center gap-3 p-3 hover:bg-gray-50 rounded-lg">
                                        <div class="w-3 h-3 rounded-full shrink-0 ${
                                            task.priority === 'high' ? 'bg-red-500' : 
                                            task.priority === 'medium' ? 'bg-yellow-500' : 'bg-green-500'
                                        }"></div>
                                        <div class="flex-1">
                                            <h4 class="font-medium">${task.title}</h4>
                                            <p class="text-sm text-gray-500">${task.date}</p>
                                        </div>
                                    </div>`).join('') : '<p class="text-gray-500">No pending tasks. Great job!</p>'}
                                </div>
                            </div>
                        </div>
                    </div>`;
            };

            const renderNotesView = () => {
                const filteredNotes = state.notes.filter(note =>
                    note.title.toLowerCase().includes(state.searchQuery.toLowerCase()) ||
                    note.content.toLowerCase().includes(state.searchQuery.toLowerCase())
                );
                return `
                    <div class="flex justify-between items-center mb-6">
                        <h3 class="text-xl font-semibold">Notes (${filteredNotes.length})</h3>
                        <button onclick="window.app.openNoteEditor()" class="flex items-center gap-2 bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700 transition-colors shadow-sm">
                            <i data-lucide="plus" class="w-5 h-5"></i>
                            New Note
                        </button>
                    </div>
                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-6">
                        ${filteredNotes.length > 0 ? filteredNotes.map(note => {
                            const tagStyle = tagColors[note.tag] || tagColors.general;
                            return `
                            <div class="bg-white rounded-xl shadow-sm border border-gray-200 p-5 flex flex-col hover:shadow-lg transition-shadow duration-300 group">
                                <div class="flex items-start justify-between mb-3">
                                    <h4 class="font-semibold text-lg flex-1 pr-2 cursor-pointer" onclick="window.app.openNoteEditor(${note.id})">${note.title}</h4>
                                    <button onclick="window.app.toggleNoteStar(${note.id})" class="p-1 rounded-full hover:bg-yellow-100">
                                      <i data-lucide="star" class="w-5 h-5 transition-colors ${note.starred ? 'text-yellow-400 fill-current' : 'text-gray-300 group-hover:text-yellow-400'}"></i>
                                    </button>
                                </div>
                                <div class="text-gray-600 text-sm mb-4 line-clamp-3 flex-grow note-content cursor-pointer" onclick="window.app.openNoteEditor(${note.id})">${note.content.replace(/<[^>]*>?/gm, ' ')}</div>
                                <div class="flex items-center justify-between text-xs text-gray-500 mt-auto pt-3 border-t border-gray-100">
                                    <span class="px-2 py-1 rounded-full ${tagStyle.bg} ${tagStyle.text} border ${tagStyle.border}">${note.tag}</span>
                                    <div class="flex items-center gap-1 opacity-0 group-hover:opacity-100 transition-opacity">
                                        <button onclick="window.app.deleteNote(${note.id})" class="p-1 rounded-full hover:bg-red-100 text-gray-400 hover:text-red-500"><i data-lucide="trash-2" class="w-4 h-4"></i></button>
                                    </div>
                                </div>
                            </div>`;
                        }).join('') : '<p class="text-gray-500 md:col-span-2 lg:col-span-3">No notes found. Try clearing your search or creating a new note.</p>'}
                    </div>
                `;
            };

            const renderNoteEditorView = () => {
                let note = { title: '', content: '', tag: '' };
                if (state.editingNoteId) {
                    note = state.notes.find(n => n.id === state.editingNoteId) || note;
                }
                return `
                    <div class="max-w-4xl mx-auto">
                        <div class="flex items-center justify-between mb-6">
                            <button onclick="window.app.setView('notes')" class="flex items-center gap-2 text-blue-600 hover:text-blue-800 font-medium">
                                <i data-lucide="arrow-left" class="w-5 h-5"></i> Back to Notes
                            </button>
                            <button onclick="window.app.saveNote()" class="flex items-center gap-2 bg-green-600 text-white px-4 py-2 rounded-lg hover:bg-green-700 shadow-sm">
                                <i data-lucide="save" class="w-5 h-5"></i> Save Note
                            </button>
                        </div>
                        <div class="bg-white rounded-xl shadow-sm border border-gray-200 overflow-hidden">
                            <div class="border-b border-gray-200 p-4">
                                <input id="note-editor-title" type="text" placeholder="Note title..."
                                    value="${note.title}"
                                    class="w-full text-2xl font-bold border-none outline-none placeholder-gray-400">
                            </div>
                            <div class="border-b border-gray-200 p-4 bg-gray-50">
                                <label class="block text-sm font-medium text-gray-700 mb-2">Tag (Required) *</label>
                                <select id="note-tag-select" class="w-full p-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500" required>
                                    <option value="">Select a tag...</option>
                                    <option value="work" ${note.tag === 'work' ? 'selected' : ''}>Work</option>
                                    <option value="personal" ${note.tag === 'personal' ? 'selected' : ''}>Personal</option>
                                    <option value="school" ${note.tag === 'school' ? 'selected' : ''}>School</option>
                                    <option value="general" ${note.tag === 'general' ? 'selected' : ''}>General</option>
                                </select>
                            </div>
                            <div class="border-b border-gray-200 p-2 flex gap-1 flex-wrap bg-gray-50">
                                <button id="boldBtn" title="Bold" class="p-2 rounded-md hover:bg-gray-200 text-gray-600"><i data-lucide="bold" class="w-5 h-5"></i></button>
                                <button id="italicBtn" title="Italic" class="p-2 rounded-md hover:bg-gray-200 text-gray-600"><i data-lucide="italic" class="w-5 h-5"></i></button>
                                <button id="underlineBtn" title="Underline" class="p-2 rounded-md hover:bg-gray-200 text-gray-600"><i data-lucide="underline" class="w-5 h-5"></i></button>
                                <button id="strikeBtn" title="Strikethrough" class="p-2 rounded-md hover:bg-gray-200 text-gray-600"><i data-lucide="strikethrough" class="w-5 h-5"></i></button>
                                <button id="listBtn" title="Bulleted List" class="p-2 rounded-md hover:bg-gray-200 text-gray-600"><i data-lucide="list" class="w-5 h-5"></i></button>
                                <button id="numberListBtn" title="Numbered List" class="p-2 rounded-md hover:bg-gray-200 text-gray-600"><i data-lucide="list-ordered" class="w-5 h-5"></i></button>
                            </div>
                            <div id="editor" contenteditable="true" class="w-full note-editor p-6 text-gray-700 leading-relaxed">${note.content}</div>
                        </div>
                    </div>`;
            };
            
            const renderTasksView = () => {
                let sortedTasks = [...state.tasks];
                if (state.taskSort === 'priority') {
                    const priorityOrder = { high: 0, medium: 1, low: 2 };
                    sortedTasks.sort((a, b) => priorityOrder[a.priority] - priorityOrder[b.priority] || a.completed - b.completed);
                } else {
                    sortedTasks.sort((a, b) => (a.date > b.date ? 1 : -1) || a.completed - b.completed);
                }
                return `
                    <div id="new-task-container" class="mb-6"></div>
                    <div class="bg-white rounded-xl shadow-sm border border-gray-200">
                        <div class="p-4 flex flex-col md:flex-row md:justify-between md:items-center border-b border-gray-200 gap-3">
                           <div class="flex items-center gap-4">
                               <h3 class="text-xl font-semibold">Tasks (${state.tasks.filter(t => !t.completed).length} pending)</h3>
                               <div class="flex gap-1">
                                   <button onclick="window.app.setTaskSort('date')" class="px-2 py-1 rounded ${state.taskSort === 'date' ? 'bg-blue-500 text-white' : 'text-gray-600 hover:bg-gray-100'} text-xs font-medium">Date</button>
                                   <button onclick="window.app.setTaskSort('priority')" class="px-2 py-1 rounded ${state.taskSort === 'priority' ? 'bg-blue-500 text-white' : 'text-gray-600 hover:bg-gray-100'} text-xs font-medium">Priority</button>
                               </div>
                           </div>
                           <button onclick="window.app.showNewTaskForm()" class="flex items-center gap-2 bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700 shadow-sm">
                               <i data-lucide="plus" class="w-5 h-5"></i> New Task
                           </button>
                        </div>
                        <div class="divide-y divide-gray-100">
                        ${sortedTasks.length > 0 ? sortedTasks.map(task => `
                        <div class="flex items-center gap-4 p-4 group">
                            <button onclick="window.app.toggleTask(${task.id})" class="w-6 h-6 rounded-full border-2 flex items-center justify-center shrink-0 transition-colors ${
                                task.completed ? 'bg-green-500 border-green-500 text-white' : 'border-gray-300 hover:border-green-400'
                            }">${task.completed ? '<i data-lucide="check" class="w-4 h-4"></i>' : ''}
                            </button>
                            <div class="flex-1">
                                <h4 class="font-medium ${task.completed ? 'line-through text-gray-500' : 'text-gray-800'}">${task.title}</h4>
                                <p class="text-sm text-gray-500">${task.date}</p>
                            </div>
                            <div class="px-3 py-1 rounded-full text-xs font-medium ${
                                task.priority === 'high' ? 'bg-red-100 text-red-800' :
                                task.priority === 'medium' ? 'bg-yellow-100 text-yellow-800' : 'bg-green-100 text-green-800'
                            }">${task.priority}</div>
                            <button onclick="window.app.deleteTask(${task.id})" class="p-1 rounded-full text-gray-400 hover:text-red-500 hover:bg-red-100 opacity-0 group-hover:opacity-100 transition-opacity">
                                <i data-lucide="trash-2" class="w-5 h-5"></i>
                            </button>
                        </div>`).join('') : '<p class="text-gray-500 p-4">No tasks yet. Add one to get started!</p>'}
                        </div>
                    </div>`;
            };

            const renderCalendarView = () => {
                const year = state.selectedDate.getFullYear();
                const month = state.selectedDate.getMonth();
                const firstDay = new Date(year, month, 1);

                const eventsByDate = {};
                state.notes.forEach(item => {
                    if (item.date) {
                        if (!eventsByDate[item.date]) eventsByDate[item.date] = [];
                        eventsByDate[item.date].push({ ...item, type: 'note' });
                    }
                });
                state.tasks.forEach(item => {
                    if (item.date) {
                        if (!eventsByDate[item.date]) eventsByDate[item.date] = [];
                        eventsByDate[item.date].push({ ...item, type: 'task' });
                    }
                });

                let calendarDays = [];
                let day = new Date(firstDay);
                day.setDate(day.getDate() - day.getDay());

                for (let i = 0; i < 42; i++) {
                    calendarDays.push(new Date(day));
                    day.setDate(day.getDate() + 1);
                }

                return `
                    <div class="bg-white rounded-xl shadow-sm border border-gray-200 p-6 relative">
                        <div class="flex items-center justify-between mb-6">
                            <h3 class="text-2xl font-semibold">${state.selectedDate.toLocaleDateString('en-US', { month: 'long', year: 'numeric' })}</h3>
                            <div class="flex gap-2">
                                <button onclick="window.app.changeMonth(-1)" class="p-2 hover:bg-gray-100 rounded-lg"><i data-lucide="chevron-left"></i></button>
                                <button onclick="window.app.changeMonth(1)" class="p-2 hover:bg-gray-100 rounded-lg"><i data-lucide="chevron-right"></i></button>
                            </div>
                        </div>
                        <div class="grid grid-cols-7 gap-1 text-center text-sm font-medium text-gray-500">
                            ${['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'].map(day => `<div class="py-2">${day}</div>`).join('')}
                        </div>
                        <div class="grid grid-cols-7 gap-1 relative" id="calendar-grid">
                            ${calendarDays.map(date => {
                                const dateString = toLocalDateString(date);
                                const isToday = toLocalDateString(new Date()) === dateString;
                                const isCurrentMonth = date.getMonth() === month;
                                const hasEvents = eventsByDate[dateString] && eventsByDate[dateString].length > 0;
                                const eventsCount = hasEvents ? eventsByDate[dateString].length : 0;
                                return `
                                <div class="h-24 p-2 text-left rounded-lg transition-colors flex flex-col relative cursor-pointer group
                                    ${isToday ? 'bg-blue-600 text-white font-bold' : 
                                    isCurrentMonth ? 'bg-white hover:bg-blue-50 text-gray-800' : 'bg-gray-50 text-gray-400'}"
                                    data-date="${dateString}">
                                  <span class="font-medium">${date.getDate()}</span>
                                  ${hasEvents ? `<div class="mt-auto flex justify-start items-center gap-1.5 opacity-70 group-hover:opacity-100">
                                      <span class="w-2 h-2 bg-red-400 rounded-full"></span>
                                      <span class="text-[10px] font-medium ${isToday ? 'text-blue-200' : 'text-gray-500'}">${eventsCount} item${eventsCount > 1 ? 's' : ''}</span>
                                  </div>` : ''}
                                </div>`;
                            }).join('')}
                        </div>
                        <div id="calendar-popover-root"></div>
                    </div>
                `;
            };

            const setupCalendarDayClicks = () => {
                const grid = document.getElementById('calendar-grid');
                if (!grid) return;
                grid.querySelectorAll('[data-date]').forEach(dayEl => {
                    dayEl.onclick = (e) => {
                        e.stopPropagation();
                        const date = dayEl.getAttribute('data-date');
                        window.app.showCalendarPopover(date, dayEl);
                    };
                });
                document.body.onclick = () => {
                    window.app.closeCalendarPopover();
                };
            };
            
            // --- PUBLIC API ---
            window.app = window.app || {};
            
            window.app.showCalendarPopover = (date, triggerEl) => {
                window.app.closeCalendarPopover();
                const root = document.getElementById('calendar-popover-root');
                const calendarGrid = document.getElementById('calendar-grid');
                if (!root || !calendarGrid) return;
            
                const events = [
                    ...state.notes.filter(n => n.date === date).map(n => ({ ...n, type: 'note' })),
                    ...state.tasks.filter(t => t.date === date).map(t => ({ ...t, type: 'task' }))
                ];
            
                if (events.length === 0) return;
                
                const friendlyDate = new Date(date + 'T00:00:00').toLocaleDateString('en-US', { weekday: 'long', month: 'long', day: 'numeric' });
                
                const popoverHTML = `
                    <div class="popover" style="position: absolute; visibility: hidden;">
                        <div class="popover-close" onclick="window.app.closeCalendarPopover(event)">
                            <i data-lucide="x" class="w-5 h-5"></i>
                        </div>
                        <h4 class="font-semibold mb-3 text-base pr-6">${friendlyDate}</h4>
                        <div class="flex flex-col gap-2 max-h-60 overflow-y-auto pr-1">
                            ${events.map(evt => evt.type === 'note'
                                ? `<div class="p-2 rounded-md bg-blue-50 flex items-start gap-2 text-sm">
                                    <i data-lucide="file-text" class="w-4 h-4 text-blue-600 shrink-0 mt-0.5"></i>
                                    <div>
                                        <div class="font-medium text-gray-800">${evt.title}</div>
                                        <div class="text-xs text-gray-500">${evt.content.replace(/<[^>]*>?/gm, '').slice(0, 40)}...</div>
                                    </div>
                                </div>`
                                : `<div class="p-2 rounded-md bg-green-50 flex items-start gap-2 text-sm">
                                    <i data-lucide="check-circle" class="w-4 h-4 text-green-600 shrink-0 mt-0.5"></i>
                                    <div>
                                        <div class="font-medium text-gray-800">${evt.title}</div>
                                        <div class="text-xs text-gray-500 capitalize">Priority: ${evt.priority}</div>
                                    </div>
                                </div>`
                            ).join('')}
                        </div>
                    </div>`;
                root.innerHTML = popoverHTML;
                lucide.createIcons();
                
                const popoverEl = root.querySelector('.popover');
                if (!popoverEl) return;
                
                const popoverRect = popoverEl.getBoundingClientRect();
                const triggerRect = triggerEl.getBoundingClientRect();

                let top = triggerEl.offsetTop + triggerEl.offsetHeight + 8;
                let left = triggerEl.offsetLeft + (triggerEl.offsetWidth / 2) - (popoverRect.width / 2);

                if (left < 8) {
                    left = 8;
                }
                if (left + popoverRect.width > calendarGrid.offsetWidth) {
                    left = calendarGrid.offsetWidth - popoverRect.width - 8;
                }
                if (triggerRect.bottom + popoverRect.height + 20 > window.innerHeight) {
                    top = triggerEl.offsetTop - popoverRect.height - 8;
                }
                
                popoverEl.style.top = `${top}px`;
                popoverEl.style.left = `${left}px`;
                popoverEl.style.visibility = 'visible';
                
                popoverEl.onclick = e => e.stopPropagation();
            };
            
            window.app.closeCalendarPopover = (event) => {
                if(event) event.stopPropagation();
                const root = document.getElementById('calendar-popover-root');
                if (root) root.innerHTML = '';
            };

            const views = {
                'dashboard': renderDashboard,
                'notes': renderNotesView,
                'note-editor': renderNoteEditorView,
                'tasks': renderTasksView,
                'calendar': renderCalendarView,
            };

            const setupEditorEventListeners = () => {
                const editor = document.getElementById('editor');
                if (!editor) return;
                const commands = {
                    'boldBtn': 'bold', 'italicBtn': 'italic', 'underlineBtn': 'underline',
                    'strikeBtn': 'strikeThrough', 'listBtn': 'insertUnorderedList', 'numberListBtn': 'insertOrderedList'
                };
                for (const [btnId, command] of Object.entries(commands)) {
                    const button = document.getElementById(btnId);
                    if (button) {
                        button.addEventListener('click', (e) => {
                            e.preventDefault();
                            document.execCommand(command, false, null);
                            editor.focus();
                        });
                    }
                }
            };
            
            const render = () => {
                window.app.closeCalendarPopover();
                const viewHtml = views[state.currentView] ? views[state.currentView]() : views['dashboard']();
                app.mainContent.innerHTML = viewHtml;
                app.headerTitle.textContent = viewTitles[state.currentView];
                app.headerDate.textContent = new Date().toLocaleDateString('en-US', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' });
                renderSidebar();
                if (state.currentView === 'note-editor') {
                    setupEditorEventListeners();
                }
                if (state.currentView === 'calendar') {
                    setupCalendarDayClicks();
                }
                 if (state.currentView === 'tasks') {
                    const container = document.getElementById('new-task-container');
                    if (container && container.innerHTML !== '') {
                        window.app.showNewTaskForm();
                    }
                }
                lucide.createIcons();
            };
            
            Object.assign(window.app, {
                setView: (view) => {
                    state.currentView = view;
                    state.editingNoteId = null;
                    state.searchQuery = '';
                    app.searchInput.value = '';
                    render();
                    window.app.toggleMobileSidebar(false);
                },
                openNoteEditor: (noteId = null) => {
                    state.editingNoteId = noteId;
                    state.currentView = 'note-editor';
                    render();
                },
                saveNote: () => {
                    const title = document.getElementById('note-editor-title').value.trim();
                    const content = document.getElementById('editor').innerHTML;
                    const tag = document.getElementById('note-tag-select').value;
                    
                    if (!title) {
                        alert('Please enter a title for your note.');
                        return;
                    }
                    if (!tag) {
                        alert('Please select a tag for your note.');
                        return;
                    }
                    
                    if (state.editingNoteId) {
                        const note = state.notes.find(n => n.id === state.editingNoteId);
                        if (note) {
                            note.title = title;
                            note.content = content;
                            note.tag = tag;
                        }
                    } else {
                        state.notes.unshift({
                            id: Date.now(), 
                            title, 
                            content, 
                            tag,
                            starred: false,
                            date: toLocalDateString(new Date())
                        });
                    }
                    saveState();
                    window.app.setView('notes');
                },
                deleteNote: (noteId) => {
                    if (confirm('Are you sure you want to delete this note? This action cannot be undone.')) {
                        state.notes = state.notes.filter(n => n.id !== noteId);
                        saveState();
                        render();
                    }
                },
                toggleNoteStar: (noteId) => {
                    const note = state.notes.find(n => n.id === noteId);
                    if (note) note.starred = !note.starred;
                    saveState();
                    render();
                },
                toggleTask: (taskId) => {
                    const task = state.tasks.find(t => t.id === taskId);
                    if (task) task.completed = !task.completed;
                    saveState();
                    render();
                },
                deleteTask: (taskId) => {
                    if (confirm('Are you sure you want to delete this task?')) {
                        state.tasks = state.tasks.filter(t => t.id !== taskId);
                        saveState();
                        render();
                    }
                },
                showNewTaskForm: () => {
                    const container = document.getElementById('new-task-container');
                    container.innerHTML = `
                        <div class="p-4 bg-gray-100 rounded-lg border border-gray-200">
                            <h4 class="font-semibold mb-3">Add New Task</h4>
                            <div class="space-y-3">
                                <input id="new-task-title" type="text" placeholder="Task description" class="w-full p-2 border border-gray-300 rounded-md">
                                <div class="grid grid-cols-2 gap-3">
                                    <input id="new-task-date" type="date" value="${toLocalDateString(new Date())}" class="w-full p-2 border border-gray-300 rounded-md">
                                    <select id="new-task-priority" class="w-full p-2 border border-gray-300 rounded-md">
                                        <option value="low">Low Priority</option>
                                        <option value="medium" selected>Medium Priority</option>
                                        <option value="high">High Priority</option>
                                    </select>
                                </div>
                                <div class="flex justify-end gap-2">
                                    <button onclick="document.getElementById('new-task-container').innerHTML = ''" class="px-4 py-2 bg-gray-200 rounded-md hover:bg-gray-300">Cancel</button>
                                    <button onclick="window.app.addTask()" class="px-4 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700">Add Task</button>
                                </div>
                            </div>
                        </div>`;
                },
                addTask: () => {
                    const title = document.getElementById('new-task-title').value.trim();
                    const date = document.getElementById('new-task-date').value;
                    const priority = document.getElementById('new-task-priority').value;
                    if (!title || !date) {
                        alert('Please fill out all task fields.');
                        return;
                    }
                    state.tasks.unshift({ id: Date.now(), title, date, priority, completed: false });
                    saveState();
                    render();
                },
                changeMonth: (direction) => {
                    state.selectedDate.setMonth(state.selectedDate.getMonth() + direction);
                    render();
                },
                setTaskSort: (type) => {
                    state.taskSort = type;
                    render();
                },
                toggleMobileSidebar: (forceOpen) => {
                    const isOpen = !app.sidebar.classList.contains('-translate-x-full');
                    const shouldBeOpen = typeof forceOpen === 'boolean' ? forceOpen : !isOpen;
                    if (shouldBeOpen) {
                        app.sidebar.classList.remove('-translate-x-full');
                        app.sidebarOverlay.classList.remove('hidden');
                    } else {
                        app.sidebar.classList.add('-translate-x-full');
                        app.sidebarOverlay.classList.add('hidden');
                    }
                }
            });

            // --- EVENT LISTENERS ---
            app.sidebarToggle.addEventListener('click', () => {
                state.sidebarCollapsed = !state.sidebarCollapsed;
                app.sidebar.classList.toggle('w-64');
                app.sidebar.classList.toggle('w-20');
                app.sidebarTitle.classList.toggle('hidden');
                app.sidebarFooter.classList.toggle('hidden');
                app.sidebarToggle.innerHTML = `<i data-lucide="${state.sidebarCollapsed ? 'panel-right-close' : 'panel-left-close'}" class="w-6 h-6"></i>`;
                renderSidebar();
            });
            app.mobileMenuBtn.addEventListener('click', () => window.app.toggleMobileSidebar());
            app.sidebarOverlay.addEventListener('click', () => window.app.toggleMobileSidebar(false));
            app.searchInput.addEventListener('input', (e) => {
                state.searchQuery = e.target.value;
                if (state.currentView === 'notes') {
                    render();
                } else if (state.currentView !== 'note-editor') {
                    window.app.setView('notes');
                }
            });

            // --- INITIALIZATION ---
            loadState();
            render();
        });
    </script>
</body>
</html>

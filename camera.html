<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Product Scanner - Real-Time Barcode & Product Lookup</title>
    <!-- ZXing for barcode scanning -->
    <script src="https://unpkg.com/@zxing/browser@0.1.4/index.js"></script>
    <!-- Tesseract.js for OCR fallback (latest version) -->
    <script src="https://unpkg.com/tesseract.js@v5.1.0/dist/tesseract.min.js"></script>
    <style>
        body { font-family: Arial, sans-serif; text-align: center; }
        video { width: 100%; max-width: 400px; border: 2px solid #ccc; }
        #overlay { position: absolute; pointer-events: none; }
        #result { margin-top: 20px; padding: 10px; border: 1px solid #ddd; }
        button { padding: 10px 20px; margin: 10px; }
    </style>
</head>
<body>
    <h1>Product Scanner</h1>
    
    <button id="startButton">Start Scanning</button>
    <button id="stopButton" style="display: none;">Stop Scanning</button>

    <div style="position: relative;">
        <video id="video" autoplay playsinline></video>
        <canvas id="overlay" style="position: absolute; top: 0; left: 0;"></canvas>
    </div>
    
    <div id="result">No product detected yet. Start scanning!</div>

    <script>
        const video = document.getElementById('video');
        const overlay = document.getElementById('overlay');
        const overlayCtx = overlay.getContext('2d');
        const startButton = document.getElementById('startButton');
        const stopButton = document.getElementById('stopButton');
        const resultDisplay = document.getElementById('result');

        let stream;
        let scanningInterval;
        let ocrTimeout;
        const scanIntervalMs = 500; // Scan every 500ms

        // Start camera and scanning
        startButton.addEventListener('click', async () => {
            try {
                stream = await navigator.mediaDevices.getUserMedia({
                    video: { facingMode: 'environment' } // Rear camera
                });
                video.srcObject = stream;
                startButton.style.display = 'none';
                stopButton.style.display = 'inline';

                // Set overlay size to match video
                video.addEventListener('loadedmetadata', () => {
                    overlay.width = video.videoWidth;
                    overlay.height = video.videoHeight;
                });

                // Start continuous barcode scanning
                scanningInterval = setInterval(scanForBarcode, scanIntervalMs);

                // Fallback to OCR if no barcode in 10 seconds
                ocrTimeout = setTimeout(() => {
                    if (!resultDisplay.innerHTML.includes('Product found')) {
                        performOCR();
                    }
                }, 10000);
            } catch (err) {
                console.error('Error accessing camera:', err);
                resultDisplay.innerHTML = 'Error accessing camera. Please grant permissions and ensure HTTPS.';
            }
        });

        // Stop scanning and camera
        stopButton.addEventListener('click', stopScanning);

        function stopScanning() {
            clearInterval(scanningInterval);
            clearTimeout(ocrTimeout);
            if (stream) stream.getTracks().forEach(track => track.stop());
            startButton.style.display = 'inline';
            stopButton.style.display = 'none';
            resultDisplay.innerHTML += '<br>Scanning stopped.';
        }

        // Real-time barcode scanning using ZXing
        async function scanForBarcode() {
            const codeReader = new ZXing.BrowserMultiFormatReader();
            try {
                const result = await codeReader.decodeFromVideoDevice(undefined, 'video', (result, err) => {
                    if (result) {
                        drawBarcodeOverlay(result); // Draw red box around barcode
                        processBarcode(result.text);
                        codeReader.reset(); // Stop after detection
                        stopScanning();
                    }
                });
            } catch (err) {
                console.error('Barcode scan error:', err);
            }
        }

        // Draw overlay for detected barcode
        function drawBarcodeOverlay(result) {
            overlayCtx.clearRect(0, 0, overlay.width, overlay.height);
            overlayCtx.strokeStyle = 'red';
            overlayCtx.lineWidth = 3;
            // Approximate box (ZXing provides points, but for simplicity, draw a full-frame box)
            overlayCtx.strokeRect(50, 50, overlay.width - 100, overlay.height - 100);
        }

        // Process detected barcode and fetch product info
        async function processBarcode(barcode) {
            resultDisplay.innerHTML = `Barcode detected: ${barcode}<br>Fetching product info...`;
            try {
                const response = await fetch(`https://world.openfoodfacts.org/api/v0/product/${barcode}.json`);
                const data = await response.json();
                if (data.status === 1) {
                    const product = data.product;
                    resultDisplay.innerHTML = `
                        <strong>Product Found:</strong><br>
                        Name: ${product.product_name || 'N/A'}<br>
                        Brand: ${product.brands || 'N/A'}<br>
                        Quantity: ${product.quantity || 'N/A'}<br>
                        Ingredients: ${product.ingredients_text || 'N/A'}<br>
                        <img src="${product.image_url}" alt="Product Image" style="max-width: 200px;"><br>
                        <a href="${product.url}" target="_blank">More Details</a>
                    `;
                } else {
                    resultDisplay.innerHTML += '<br>No exact match found. Try these searches:<br>';
                    addSearchLinks(barcode);
                }
            } catch (err) {
                console.error('API error:', err);
                resultDisplay.innerHTML += '<br>Error fetching product. Try searches:<br>';
                addSearchLinks(barcode);
            }
        }

        // Fallback OCR using Tesseract
        async function performOCR() {
            resultDisplay.innerHTML = 'No barcode found. Trying text recognition...';
            const worker = await Tesseract.createWorker('eng');
            try {
                const { data: { text } } = await worker.recognize(video);
                await worker.terminate();
                if (text.trim()) {
                    resultDisplay.innerHTML = `Detected text: ${text}<br>Searching for product...`;
                    addSearchLinks(text);
                } else {
                    resultDisplay.innerHTML = 'No text detected.';
                }
            } catch (err) {
                console.error('OCR error:', err);
                resultDisplay.innerHTML = 'Error with text recognition.';
            }
        }

        // Add search links as fallback
        function addSearchLinks(query) {
            const searchUrls = [
                `https://www.shoprite.co.za/search/all?q=${encodeURIComponent(query)}`,
                `https://www.pnp.co.za/search/?text=${encodeURIComponent(query)}`
            ];
            resultDisplay.innerHTML += searchUrls.map(url => `<a href="${url}" target="_blank">Search on Site</a>`).join('<br>');
        }
    </script>
</body>
</html>
